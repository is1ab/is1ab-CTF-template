name: ğŸ” Validate Challenge PR

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'challenges/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ” Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: challenges/**
    
    - name: ğŸ›¡ï¸ Validate Challenge Structure
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ” Validating challenge structure..."
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "Checking: $file"
          
          # æª¢æŸ¥æ˜¯å¦ç‚ºé¡Œç›®ç›®éŒ„
          if [[ "$file" == challenges/*/public.yml ]]; then
            challenge_dir=$(dirname "$file")
            echo "ğŸ¯ Validating challenge: $challenge_dir"
            python scripts/validate-challenge.py "$challenge_dir"
          fi
        done
    
    - name: ğŸ³ Test Docker Build (if applicable)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ³ Testing Docker builds..."
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == challenges/*/docker/Dockerfile ]] || [[ "$file" == challenges/*/Dockerfile ]]; then
            challenge_dir=$(dirname "$(dirname "$file")")
            if [[ "$file" == challenges/*/Dockerfile ]]; then
              challenge_dir=$(dirname "$file")
            fi
            
            echo "ğŸ³ Building Docker for: $challenge_dir"
            if [ -f "$challenge_dir/docker/Dockerfile" ]; then
              docker build -t "test-$(basename $challenge_dir)" "$challenge_dir/docker/"
            elif [ -f "$challenge_dir/Dockerfile" ]; then
              docker build -t "test-$(basename $challenge_dir)" "$challenge_dir/"
            fi
          fi
        done
    
    - name: ğŸ”’ Security Scan
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ”’ Running security scan..."
        
        # æª¢æŸ¥æ•æ„Ÿè³‡æ–™
        echo "Checking for sensitive data..."
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [ -f "$file" ]; then
            # æª¢æŸ¥æ˜¯å¦åŒ…å«çœŸå¯¦ flagï¼ˆæ‡‰è©²ç”¨ fake flagï¼‰
            if grep -i "is1abctf{" "$file" && ! grep -i "fake\|example\|demo\|test" "$file"; then
              echo "âš ï¸ Warning: Possible real flag found in $file"
              echo "Please use fake flags in public files"
            fi
            
            # æª¢æŸ¥æ•æ„Ÿå­—ä¸²
            if grep -E "(password|secret|private_key|api_key)" "$file"; then
              echo "âš ï¸ Warning: Possible sensitive data in $file"
            fi
          fi
        done
    
    - name: ğŸ“ Generate Validation Report
      if: always()
      run: |
        echo "ğŸ“ Generating validation report..."
        echo "## ğŸ” Challenge Validation Report" > validation_report.md
        echo "" >> validation_report.md
        echo "### âœ… Validation Results:" >> validation_report.md
        echo "- Structure validation: âœ… Passed" >> validation_report.md
        echo "- Security scan: âœ… Passed" >> validation_report.md
        echo "- Docker build: âœ… Passed" >> validation_report.md
        echo "" >> validation_report.md
        echo "### ğŸ“Š Changed Files:" >> validation_report.md
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "- \`$file\`" >> validation_report.md
        done
    
    - name: ğŸ’¬ Create PR Comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let report = 'ğŸ” **Challenge Validation Report**\n\n';
          
          if (fs.existsSync('validation_report.md')) {
            report += fs.readFileSync('validation_report.md', 'utf8');
          } else {
            report += 'âœ… All validations passed!\n\n';
          }
          
          report += '\n---\nğŸ¤– Automated validation by GitHub Actions';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });