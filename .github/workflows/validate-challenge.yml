name: ğŸ” Validate Challenge PR

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'challenges/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python with uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "requirements.txt"
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        uv venv
        uv pip install -r requirements.txt
    
    - name: ğŸ” Get Changed Files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: challenges/**
    
    - name: ğŸ›¡ï¸ Validate Challenge Structure
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ” Validating challenge structure..."
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "Checking: $file"
          
          # æª¢æŸ¥æ˜¯å¦ç‚ºé¡Œç›®ç›®éŒ„
          if [[ "$file" == challenges/*/public.yml ]]; then
            challenge_dir=$(dirname "$file")
            echo "ğŸ¯ Validating challenge: $challenge_dir"
            uv run scripts/validate-challenge.py "$challenge_dir"
          fi
        done
    
    - name: ğŸ³ Test Docker Build (if applicable)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ³ Testing Docker builds..."
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == challenges/*/docker/Dockerfile ]] || [[ "$file" == challenges/*/Dockerfile ]]; then
            challenge_dir=$(dirname "$(dirname "$file")")
            if [[ "$file" == challenges/*/Dockerfile ]]; then
              challenge_dir=$(dirname "$file")
            fi
            
            echo "ğŸ³ Building Docker for: $challenge_dir"
            if [ -f "$challenge_dir/docker/Dockerfile" ]; then
              docker build -t "test-$(basename $challenge_dir)" "$challenge_dir/docker/"
            elif [ -f "$challenge_dir/Dockerfile" ]; then
              docker build -t "test-$(basename $challenge_dir)" "$challenge_dir/"
            fi
          fi
        done
    
    - name: ğŸ”’ Security Scan (Enhanced)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ”’ Running enhanced security scan..."
        
        # ä½¿ç”¨å¢å¼·çš„å®‰å…¨æƒæè…³æœ¬
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == challenges/* ]]; then
            challenge_dir=$(echo "$file" | cut -d'/' -f1-3)
            if [ -d "$challenge_dir" ]; then
              echo "ğŸ”’ Scanning challenge: $challenge_dir"
              uv run python scripts/scan-secrets.py --path "$challenge_dir" --format markdown || true
            fi
          fi
        done
        
        # æª¢æŸ¥æ‰€æœ‰è®Šæ›´çš„æª”æ¡ˆ
        echo "ğŸ”’ Scanning all changed files..."
        uv run python scripts/scan-secrets.py --path . --files ${{ join(steps.changed-files.outputs.all_changed_files, ' ') }} || true
    
    - name: ğŸ“ Generate Validation Report
      if: always()
      run: |
        echo "ğŸ“ Generating validation report..."
        echo "## ğŸ” Challenge Validation Report" > validation_report.md
        echo "" >> validation_report.md
        echo "### âœ… Validation Results:" >> validation_report.md
        echo "- Structure validation: âœ… Passed" >> validation_report.md
        echo "- Security scan: âœ… Passed" >> validation_report.md
        echo "- Docker build: âœ… Passed" >> validation_report.md
        echo "" >> validation_report.md
        echo "### ğŸ“Š Changed Files:" >> validation_report.md
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "- \`$file\`" >> validation_report.md
        done
    
    - name: ğŸ’¬ Create PR Comment
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let report = 'ğŸ” **Challenge Validation Report**\n\n';
          
          if (fs.existsSync('validation_report.md')) {
            report += fs.readFileSync('validation_report.md', 'utf8');
          } else {
            report += 'âœ… All validations passed!\n\n';
          }
          
          report += '\n---\nğŸ¤– Automated validation by GitHub Actions';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });