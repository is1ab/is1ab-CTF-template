# =============================================================================
# ğŸ”’ Security Scan Workflow
# =============================================================================
# åŠŸèƒ½ï¼š
# 1. æƒæ Flag æ ¼å¼å­—ä¸²
# 2. æª¢æ¸¬æ•æ„Ÿæª”æ¡ˆ
# 3. é©—è­‰ private.yml ä¸åœ¨å…¬é–‹åˆ†æ”¯
# 4. æª¢æŸ¥ Docker ç’°å¢ƒè®Šæ•¸
# =============================================================================

name: ğŸ”’ Security Scan

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'challenges/**'
      - 'public-release/**'
      - '**.yml'
      - '**.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'challenges/**'
      - 'public-release/**'
  workflow_dispatch:
    inputs:
      scan_path:
        description: 'æƒæè·¯å¾‘'
        required: false
        default: '.'
      fail_on_high:
        description: 'ç™¼ç¾ HIGH ç­‰ç´šå•é¡Œæ™‚å¤±æ•—'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # ===========================================================================
  # Job 1: Flag æ´©æ¼æƒæ
  # ===========================================================================
  flag-scan:
    name: ğŸš© Flag æ´©æ¼æƒæ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” æƒæ Flag æ ¼å¼
        id: flag-scan
        run: |
          echo "ğŸ” æƒæ Flag æ ¼å¼å­—ä¸²..."
          
          # å¾ config.yml è®€å– flag å‰ç¶´
          FLAG_PREFIX=$(grep -E "^\s*flag_prefix:" config.yml 2>/dev/null | awk -F'"' '{print $2}' | head -1)
          FLAG_PREFIX=${FLAG_PREFIX:-is1abCTF}
          
          echo "Flag å‰ç¶´: $FLAG_PREFIX"
          
          # æƒæ flag æ ¼å¼ï¼ˆæ’é™¤ private.yml å’Œç‰¹å®šç›®éŒ„ï¼‰
          FINDINGS=$(grep -rn "${FLAG_PREFIX}{[^}]*}" \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.md" \
            --include="*.py" \
            --include="*.js" \
            --include="*.html" \
            --exclude="private.yml" \
            --exclude="*.template" \
            --exclude-dir=".git" \
            --exclude-dir="node_modules" \
            --exclude-dir=".venv" \
            --exclude-dir="challenge-template" \
            --exclude-dir="challenge-templates" \
            . 2>/dev/null || true)
          
          if [ -n "$FINDINGS" ]; then
            echo "::error::ç™¼ç¾ Flag æ´©æ¼ï¼"
            echo "ç™¼ç¾çš„ Flagï¼š"
            echo "$FINDINGS"
            echo "flag_found=true" >> $GITHUB_OUTPUT
            echo "$FINDINGS" > flag_findings.txt
          else
            echo "âœ… æœªç™¼ç¾ Flag æ´©æ¼"
            echo "flag_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ ä¸Šå‚³ Flag æƒæçµæœ
        if: steps.flag-scan.outputs.flag_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: flag-scan-results
          path: flag_findings.txt
          retention-days: 7

  # ===========================================================================
  # Job 2: æ•æ„Ÿæª”æ¡ˆæª¢æŸ¥
  # ===========================================================================
  sensitive-files:
    name: ğŸ“ æ•æ„Ÿæª”æ¡ˆæª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” æª¢æŸ¥æ•æ„Ÿæª”æ¡ˆ
        id: sensitive-check
        run: |
          echo "ğŸ” æª¢æŸ¥æ•æ„Ÿæª”æ¡ˆ..."
          
          SENSITIVE_FILES=(
            "private.yml"
            "secrets.yml"
            "secrets.json"
            "flag.txt"
            ".env.local"
            ".env.production"
            "credentials.json"
          )
          
          FOUND_FILES=""
          
          for pattern in "${SENSITIVE_FILES[@]}"; do
            # æœå°‹å…¬é–‹ç›®éŒ„ä¸­çš„æ•æ„Ÿæª”æ¡ˆ
            MATCHES=$(find . -name "$pattern" \
              -not -path "./.git/*" \
              -not -path "./challenge-template/*" \
              -not -path "./challenge-templates/*" \
              2>/dev/null || true)
            
            # ç‰¹åˆ¥æª¢æŸ¥ public-release ç›®éŒ„
            PUBLIC_MATCHES=$(find ./public-release -name "$pattern" 2>/dev/null || true)
            
            if [ -n "$PUBLIC_MATCHES" ]; then
              echo "::error::åœ¨ public-release ä¸­ç™¼ç¾æ•æ„Ÿæª”æ¡ˆ: $pattern"
              FOUND_FILES="$FOUND_FILES\n$PUBLIC_MATCHES"
            fi
          done
          
          if [ -n "$FOUND_FILES" ]; then
            echo "sensitive_found=true" >> $GITHUB_OUTPUT
            echo -e "$FOUND_FILES" > sensitive_files.txt
          else
            echo "âœ… æœªåœ¨å…¬é–‹ç›®éŒ„ä¸­ç™¼ç¾æ•æ„Ÿæª”æ¡ˆ"
            echo "sensitive_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ ä¸Šå‚³æ•æ„Ÿæª”æ¡ˆå ±å‘Š
        if: steps.sensitive-check.outputs.sensitive_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sensitive-files-report
          path: sensitive_files.txt
          retention-days: 7

  # ===========================================================================
  # Job 3: é€²éšå®‰å…¨æƒæ
  # ===========================================================================
  advanced-scan:
    name: ğŸ”¬ é€²éšå®‰å…¨æƒæ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python with uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: |
          uv venv
          uv pip install pyyaml
      
      - name: ğŸ”¬ åŸ·è¡Œé€²éšæƒæ
        id: advanced-scan
        run: |
          SCAN_PATH="${{ github.event.inputs.scan_path || '.' }}"
          
          echo "ğŸ”¬ åŸ·è¡Œé€²éšå®‰å…¨æƒæ..."
          echo "æƒæè·¯å¾‘: $SCAN_PATH"
          
          # åŸ·è¡Œè‡ªå®šç¾©æƒæè…³æœ¬
          if [ -f "scripts/scan-secrets.py" ]; then
            uv run python scripts/scan-secrets.py \
              --path "$SCAN_PATH" \
              --format markdown \
              --output security-report.md \
              ${{ github.event.inputs.fail_on_high == 'true' && '--fail-on-high' || '' }} \
              || echo "scan_failed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ scan-secrets.py ä¸å­˜åœ¨ï¼Œè·³éé€²éšæƒæ"
          fi
      
      - name: ğŸ“¤ ä¸Šå‚³å®‰å…¨å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ğŸ’¬ PR è©•è«–
        if: github.event_name == 'pull_request' && hashFiles('security-report.md') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## ğŸ”’ å®‰å…¨æƒæå ±å‘Š\n\n';
            
            if (fs.existsSync('security-report.md')) {
              report += fs.readFileSync('security-report.md', 'utf8');
            } else {
              report += 'âœ… æƒæå®Œæˆï¼Œæœªç™¼ç¾å•é¡Œã€‚\n';
            }
            
            report += '\n---\nğŸ¤– ç”± Security Scan Workflow è‡ªå‹•ç”Ÿæˆ';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ===========================================================================
  # Job 4: Docker å®‰å…¨æª¢æŸ¥
  # ===========================================================================
  docker-security:
    name: ğŸ³ Docker å®‰å…¨æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ æƒæ Docker é…ç½®
        id: docker-scan
        run: |
          echo "ğŸ³ æƒæ Docker é…ç½®..."
          
          # å¾ config.yml è®€å– flag å‰ç¶´
          FLAG_PREFIX=$(grep -E "^\s*flag_prefix:" config.yml 2>/dev/null | awk -F'"' '{print $2}' | head -1)
          FLAG_PREFIX=${FLAG_PREFIX:-is1abCTF}
          
          DOCKER_ISSUES=""
          
          # æª¢æŸ¥ Dockerfile ä¸­çš„ç¡¬ç·¨ç¢¼ Flag
          for dockerfile in $(find . -name "Dockerfile" -not -path "./.git/*"); do
            if grep -q "${FLAG_PREFIX}{" "$dockerfile"; then
              echo "::error::Dockerfile ä¸­ç™¼ç¾ç¡¬ç·¨ç¢¼ Flag: $dockerfile"
              DOCKER_ISSUES="$DOCKER_ISSUES\n- $dockerfile: ç¡¬ç·¨ç¢¼ Flag"
            fi
            
            # æª¢æŸ¥æ˜¯å¦ä»¥ root é‹è¡Œ
            if ! grep -q "USER" "$dockerfile"; then
              echo "::warning::Dockerfile æœªæŒ‡å®šé root ç”¨æˆ¶: $dockerfile"
            fi
          done
          
          # æª¢æŸ¥ docker-compose.yml ä¸­çš„ç¡¬ç·¨ç¢¼ Flag
          for compose in $(find . -name "docker-compose*.yml" -not -path "./.git/*"); do
            if grep -q "${FLAG_PREFIX}{" "$compose"; then
              echo "::error::docker-compose.yml ä¸­ç™¼ç¾ç¡¬ç·¨ç¢¼ Flag: $compose"
              DOCKER_ISSUES="$DOCKER_ISSUES\n- $compose: ç¡¬ç·¨ç¢¼ Flag"
            fi
          done
          
          if [ -n "$DOCKER_ISSUES" ]; then
            echo "docker_issues=true" >> $GITHUB_OUTPUT
            echo -e "$DOCKER_ISSUES" > docker_issues.txt
          else
            echo "âœ… Docker é…ç½®å®‰å…¨æª¢æŸ¥é€šé"
            echo "docker_issues=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ ä¸Šå‚³ Docker æª¢æŸ¥å ±å‘Š
        if: steps.docker-scan.outputs.docker_issues == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docker-security-report
          path: docker_issues.txt
          retention-days: 7

  # ===========================================================================
  # Job 5: ç¬¬ä¸‰æ–¹å®‰å…¨å·¥å…·
  # ===========================================================================
  third-party-scan:
    name: ğŸ›¡ï¸ ç¬¬ä¸‰æ–¹å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” TruffleHog æƒæ
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head: HEAD
          extra_args: --only-verified
      
      - name: ğŸ” GitLeaks æƒæ
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: true

  # ===========================================================================
  # Job 6: å½™ç¸½çµæœ
  # ===========================================================================
  summary:
    name: ğŸ“Š å½™ç¸½çµæœ
    runs-on: ubuntu-latest
    needs: [flag-scan, sensitive-files, advanced-scan, docker-security]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆå½™ç¸½å ±å‘Š
        run: |
          echo "# ğŸ”’ å®‰å…¨æƒæå½™ç¸½å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æª¢æŸ¥é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Flag æ´©æ¼æƒæ | ${{ needs.flag-scan.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ•æ„Ÿæª”æ¡ˆæª¢æŸ¥ | ${{ needs.sensitive-files.result == 'success' && 'âœ… é€šé' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é€²éšå®‰å…¨æƒæ | ${{ needs.advanced-scan.result == 'success' && 'âœ… é€šé' || 'âš ï¸ è­¦å‘Š' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker å®‰å…¨æª¢æŸ¥ | ${{ needs.docker-security.result == 'success' && 'âœ… é€šé' || 'âš ï¸ è­¦å‘Š' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… æƒææ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ æª¢æŸ¥å¤±æ•—æ¢ä»¶
        if: needs.flag-scan.result == 'failure' || needs.sensitive-files.result == 'failure'
        run: |
          echo "::error::å®‰å…¨æƒæå¤±æ•—ï¼è«‹ä¿®å¾©å•é¡Œå¾Œé‡æ–°æäº¤ã€‚"
          exit 1

