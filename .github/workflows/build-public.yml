# =============================================================================
# ğŸ—ï¸ Build Public Release Workflow
# =============================================================================
# åŠŸèƒ½ï¼š
# 1. åŸ·è¡Œ build.sh å»ºç½®å…¬é–‹ç‰ˆæœ¬
# 2. é©—è­‰è¼¸å‡ºç„¡æ•æ„Ÿè³‡æ–™
# 3. æ¨é€åˆ° public repository
# 4. ç”Ÿæˆå»ºç½®å ±å‘Š
# =============================================================================

name: ğŸ—ï¸ Build Public Release

on:
  push:
    branches: [ main ]
    paths:
      - 'challenges/**'
      - 'scripts/build.sh'
      - 'scripts/scan-secrets.py'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Public repository (owner/repo)'
        required: true
        default: ''
      include_writeups:
        description: 'åŒ…å« Writeupï¼ˆæ¯”è³½çµæŸå¾Œï¼‰'
        required: false
        default: 'false'
        type: boolean
      force_rebuild:
        description: 'å¼·åˆ¶é‡æ–°å»ºç½®'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'æ¨¡æ“¬åŸ·è¡Œï¼ˆä¸æ¨é€ï¼‰'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: read

env:
  PUBLIC_REPO: ${{ github.event.inputs.target_repo || secrets.PUBLIC_REPO }}

jobs:
  # ===========================================================================
  # Job 1: å»ºç½®æº–å‚™
  # ===========================================================================
  prepare:
    name: ğŸ“‹ å»ºç½®æº–å‚™
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      challenge_count: ${{ steps.count.outputs.count }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” æª¢æŸ¥æ˜¯å¦éœ€è¦å»ºç½®
        id: check
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰æº–å‚™å¥½ç™¼å¸ƒçš„é¡Œç›®
          READY_COUNT=$(find challenges -name "public.yml" -exec grep -l "ready_for_release: true" {} \; 2>/dev/null | wc -l)
          
          echo "æº–å‚™ç™¼å¸ƒçš„é¡Œç›®æ•¸: $READY_COUNT"
          
          if [ "$READY_COUNT" -gt 0 ] || [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "::warning::æ²’æœ‰é¡Œç›®æº–å‚™å¥½ç™¼å¸ƒï¼Œè·³éå»ºç½®"
          fi
      
      - name: ğŸ“Š çµ±è¨ˆé¡Œç›®æ•¸é‡
        id: count
        run: |
          TOTAL=$(find challenges -name "public.yml" | wc -l)
          READY=$(find challenges -name "public.yml" -exec grep -l "ready_for_release: true" {} \; 2>/dev/null | wc -l)
          
          echo "count=$READY/$TOTAL" >> $GITHUB_OUTPUT
          echo "ğŸ“Š é¡Œç›®çµ±è¨ˆ: $READY å€‹æº–å‚™ç™¼å¸ƒ / $TOTAL å€‹ç¸½é¡Œç›®"

  # ===========================================================================
  # Job 2: åŸ·è¡Œå»ºç½®
  # ===========================================================================
  build:
    name: ğŸ”¨ å»ºç½®å…¬é–‹ç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python with uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: |
          uv venv
          uv pip install pyyaml
      
      - name: ğŸ”¨ åŸ·è¡Œå»ºç½®è…³æœ¬
        id: build
        run: |
          echo "ğŸ”¨ é–‹å§‹å»ºç½®å…¬é–‹ç‰ˆæœ¬..."
          
          BUILD_ARGS="--force"
          
          if [ "${{ github.event.inputs.include_writeups }}" = "true" ]; then
            BUILD_ARGS="$BUILD_ARGS --include-writeups"
          fi
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            BUILD_ARGS="$BUILD_ARGS --dry-run"
          fi
          
          chmod +x scripts/build.sh
          ./scripts/build.sh $BUILD_ARGS
          
          echo "âœ… å»ºç½®å®Œæˆ"
      
      - name: ğŸ“¤ ä¸Šå‚³å»ºç½®ç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: public-release
          path: public-release/
          retention-days: 30
      
      - name: ğŸ“¤ ä¸Šå‚³å»ºç½®å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.md
          retention-days: 30

  # ===========================================================================
  # Job 3: å®‰å…¨é©—è­‰
  # ===========================================================================
  verify:
    name: ğŸ”’ å®‰å…¨é©—è­‰
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: public-release
          path: public-release/
      
      - name: ğŸ Setup Python with uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: |
          uv venv
          uv pip install pyyaml
      
      - name: ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ
        id: security
        run: |
          echo "ğŸ”’ å°å»ºç½®ç”¢ç‰©åŸ·è¡Œå®‰å…¨æƒæ..."
          
          # åŸ·è¡Œæƒæè…³æœ¬
          if [ -f "scripts/scan-secrets.py" ]; then
            uv run python scripts/scan-secrets.py \
              --path public-release \
              --format markdown \
              --output verification-report.md \
              --fail-on-high
            
            SCAN_RESULT=$?
            
            if [ $SCAN_RESULT -eq 0 ]; then
              echo "âœ… å®‰å…¨é©—è­‰é€šé"
              echo "verified=true" >> $GITHUB_OUTPUT
            else
              echo "::error::å®‰å…¨é©—è­‰å¤±æ•—ï¼ç™¼ç¾æ•æ„Ÿè³‡æ–™"
              echo "verified=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # ç°¡å–®çš„ grep æª¢æŸ¥ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
            FLAG_PREFIX=$(grep -E "^\s*flag_prefix:" config.yml 2>/dev/null | awk -F'"' '{print $2}' | head -1)
            FLAG_PREFIX=${FLAG_PREFIX:-is1abCTF}
            
            if grep -rq "${FLAG_PREFIX}{[^}]*}" public-release/; then
              echo "::error::å»ºç½®ç”¢ç‰©ä¸­ç™¼ç¾ Flagï¼"
              echo "verified=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo "âœ… ç°¡å–®å®‰å…¨é©—è­‰é€šé"
            echo "verified=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“¤ ä¸Šå‚³é©—è­‰å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report
          path: verification-report.md
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Job 4: æ¨é€åˆ° Public Repository
  # ===========================================================================
  deploy:
    name: ğŸš€ æ¨é€åˆ° Public Repo
    runs-on: ubuntu-latest
    needs: [build, verify]
    if: |
      github.event.inputs.dry_run != 'true' && 
      needs.verify.result == 'success' &&
      (github.event.inputs.target_repo != '' || env.PUBLIC_REPO != '')
    
    steps:
      - name: ğŸ“¥ ä¸‹è¼‰å»ºç½®ç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          name: public-release
          path: public-release/
      
      - name: ğŸ”§ è¨­å®š Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: ğŸš€ æ¨é€åˆ° Public Repository
        env:
          DEPLOY_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          TARGET_REPO="${{ github.event.inputs.target_repo || env.PUBLIC_REPO }}"
          
          if [ -z "$TARGET_REPO" ]; then
            echo "::error::æœªæŒ‡å®šç›®æ¨™ repository"
            exit 1
          fi
          
          echo "ğŸš€ æ¨é€åˆ°: $TARGET_REPO"
          
          cd public-release
          
          # åˆå§‹åŒ– Git
          git init
          git add .
          
          # å»ºç«‹æäº¤
          git commit -m "ğŸš€ Public Release Update
          
          ğŸ“Š Release Statistics:
          - Challenges: ${{ needs.prepare.outputs.challenge_count }}
          - Include Writeups: ${{ github.event.inputs.include_writeups || 'false' }}
          - Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          ğŸ”— Source: ${{ github.repository }}@${{ github.sha }}
          ğŸ¤– Generated by GitHub Actions"
          
          # è¨­å®šé ç«¯ä¸¦æ¨é€
          git remote add origin "https://x-access-token:${DEPLOY_TOKEN}@github.com/${TARGET_REPO}.git"
          git branch -M main
          git push -f origin main
          
          echo "âœ… æˆåŠŸæ¨é€åˆ° $TARGET_REPO"
      
      - name: ğŸ“ å»ºç«‹ GitHub Release
        if: github.event.inputs.include_writeups == 'true'
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ github.event.inputs.target_repo || env.PUBLIC_REPO }}
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          tag_name: release-${{ github.run_number }}
          name: "CTF Challenge Archive - Build ${{ github.run_number }}"
          body: |
            ## ğŸ‰ CTF Challenge Archive Release
            
            ğŸ“Š **Statistics**
            - Challenges: ${{ needs.prepare.outputs.challenge_count }}
            - Include Writeups: ${{ github.event.inputs.include_writeups || 'false' }}
            
            ğŸ“… **Build Date**: ${{ github.event.inputs.dry_run == 'true' && 'DRY RUN' || '' }} $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            
            ğŸ”— **Source**: ${{ github.repository }}@${{ github.sha }}
          draft: false
          prerelease: false

  # ===========================================================================
  # Job 5: é€šçŸ¥
  # ===========================================================================
  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare, build, verify, deploy]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆæ‘˜è¦
        run: |
          echo "# ğŸ—ï¸ Build Public Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š å»ºç½®ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| éšæ®µ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æº–å‚™ | ${{ needs.prepare.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å»ºç½® | ${{ needs.build.result == 'success' && 'âœ…' || needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é©—è­‰ | ${{ needs.verify.result == 'success' && 'âœ…' || needs.verify.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½² | ${{ needs.deploy.result == 'success' && 'âœ…' || needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **é¡Œç›®æ•¸é‡**: ${{ needs.prepare.outputs.challenge_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ¨™ Repo**: ${{ github.event.inputs.target_repo || env.PUBLIC_REPO || 'æœªè¨­å®š' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒ…å« Writeup**: ${{ github.event.inputs.include_writeups || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡æ“¬åŸ·è¡Œ**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… å»ºç½®æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¢ Slack é€šçŸ¥
        if: env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ needs.deploy.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸ—ï¸ *Public Release Build*\n\nStatus: ${STATUS}\nChallenges: ${{ needs.prepare.outputs.challenge_count }}\nRepo: ${{ github.event.inputs.target_repo || env.PUBLIC_REPO || 'N/A' }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\"
            }" \
            "$SLACK_WEBHOOK_URL"

