# =============================================================================
# ğŸš€ Auto Release to Public Repository
# =============================================================================
# åŠŸèƒ½ï¼š
# 1. æ¯”è³½çµæŸå¾Œè‡ªå‹•ç™¼å¸ƒé¡Œç›®åˆ°å…¬é–‹ Repository
# 2. åŸ·è¡Œå®Œæ•´çš„å®‰å…¨æƒæå’Œå»ºç½®æµç¨‹
# 3. è‡ªå‹•åŒæ­¥åˆ° Public Repository
# 4. è§¸ç™¼ GitHub Pages éƒ¨ç½²
# =============================================================================

name: ğŸš€ Auto Release to Public

on:
  # ç•¶å‰µå»º Release æ™‚è‡ªå‹•è§¸ç™¼
  release:
    types: [published]

  # æ”¯æ´æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (ä¾‹å¦‚ï¼š2025-01-final)'
        required: true
        type: string
      target_repo:
        description: 'Target public repository (ä¾‹å¦‚ï¼šorg/repo-public)'
        required: true
        type: string
      dry_run:
        description: 'æ¸¬è©¦æ¨¡å¼ï¼ˆä¸å¯¦éš›æ¨é€ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

jobs:
  # ===========================================================================
  # Job 1: æº–å‚™å…¬é–‹ç™¼å¸ƒç‰ˆæœ¬
  # ===========================================================================
  prepare-release:
    name: ğŸ“¦ æº–å‚™å…¬é–‹ç™¼å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Private Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python with uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: ğŸ“¦ Install Dependencies
        run: |
          uv venv
          uv pip install pyyaml

      - name: ğŸ“Š çµ±è¨ˆé¡Œç›®è³‡è¨Š
        id: stats
        run: |
          echo "ğŸ“Š çµ±è¨ˆé¡Œç›®æ•¸é‡..."
          TOTAL=$(find challenges/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')
          WEB=$(find challenges/web/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')
          PWN=$(find challenges/pwn/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')
          CRYPTO=$(find challenges/crypto/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')
          REVERSE=$(find challenges/reverse/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')
          MISC=$(find challenges/misc/ -name "public.yml" 2>/dev/null | wc -l | tr -d ' ')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "web=$WEB" >> $GITHUB_OUTPUT
          echo "pwn=$PWN" >> $GITHUB_OUTPUT
          echo "crypto=$CRYPTO" >> $GITHUB_OUTPUT
          echo "reverse=$REVERSE" >> $GITHUB_OUTPUT
          echo "misc=$MISC" >> $GITHUB_OUTPUT

          echo "ğŸ“Š é¡Œç›®çµ±è¨ˆ:"
          echo "  ç¸½è¨ˆ: $TOTAL"
          echo "  Web: $WEB"
          echo "  Pwn: $PWN"
          echo "  Crypto: $CRYPTO"
          echo "  Reverse: $REVERSE"
          echo "  Misc: $MISC"

      - name: ğŸ”’ Pre-Release Security Scan
        run: |
          echo "ğŸ”’ åŸ·è¡Œç™¼å¸ƒå‰å®‰å…¨æƒæ..."

          if [ -f "scripts/scan-secrets.py" ]; then
            uv run python scripts/scan-secrets.py \
              --path challenges/ \
              --format markdown \
              --output pre-release-scan.md \
              --fail-on-critical

            if [ $? -ne 0 ]; then
              echo "::error::å®‰å…¨æƒæç™¼ç¾ CRITICAL å•é¡Œï¼Œåœæ­¢ç™¼å¸ƒæµç¨‹"
              exit 1
            fi
          else
            echo "âš ï¸ scan-secrets.py ä¸å­˜åœ¨ï¼Œè·³éå®‰å…¨æƒæ"
          fi

      - name: ğŸ—ï¸ Build Public Release
        run: |
          echo "ğŸ—ï¸ å»ºç½®å…¬é–‹ç‰ˆæœ¬..."

          # å‰µå»ºå…¬é–‹ç™¼å¸ƒç›®éŒ„
          mkdir -p public-release/challenges
          mkdir -p public-release/docs

          # è¤‡è£½æ¯å€‹é¡Œç›®çš„å…¬é–‹å…§å®¹
          for challenge_dir in challenges/*/; do
            if [ ! -d "$challenge_dir" ]; then
              continue
            fi

            challenge_name=$(basename "$challenge_dir")
            category=$(basename $(dirname "$challenge_dir"))

            echo "  è™•ç†é¡Œç›®: $category/$challenge_name"

            # å‰µå»ºç›®æ¨™ç›®éŒ„
            mkdir -p "public-release/challenges/$challenge_name"

            # è¤‡è£½å…¬é–‹æª”æ¡ˆ
            if [ -f "$challenge_dir/public.yml" ]; then
              cp "$challenge_dir/public.yml" "public-release/challenges/$challenge_name/"
            fi

            # è¤‡è£½ files ç›®éŒ„ï¼ˆæä¾›çµ¦åƒè³½è€…çš„é™„ä»¶ï¼‰
            if [ -d "$challenge_dir/files" ]; then
              cp -r "$challenge_dir/files" "public-release/challenges/$challenge_name/"
            fi

            # è¤‡è£½ writeupï¼ˆå¦‚æœæ¨™è¨˜ç‚ºå…¬é–‹ï¼‰
            if [ -d "$challenge_dir/writeup" ]; then
              # æª¢æŸ¥ writeup æ˜¯å¦æ‡‰è©²å…¬é–‹
              if grep -q "public_writeup: true" "$challenge_dir/public.yml" 2>/dev/null; then
                cp -r "$challenge_dir/writeup" "public-release/challenges/$challenge_name/"
              fi
            fi
          done

          # è¤‡è£½å¿…è¦çš„æ–‡æª”
          cp README.md public-release/ 2>/dev/null || echo "âš ï¸ README.md ä¸å­˜åœ¨"
          cp LICENSE public-release/ 2>/dev/null || echo "âš ï¸ LICENSE ä¸å­˜åœ¨"

          echo "âœ… å…¬é–‹ç‰ˆæœ¬å»ºç½®å®Œæˆ"

      - name: ğŸ” Validate Public Release
        run: |
          echo "ğŸ” é©—è­‰å…¬é–‹ç‰ˆæœ¬..."

          # æª¢æŸ¥æ˜¯å¦æœ‰ flag æ´©æ¼
          FLAG_PREFIX=$(grep -E "^\s*flag_prefix:" config.yml 2>/dev/null | awk -F'"' '{print $2}' | head -1)
          FLAG_PREFIX=${FLAG_PREFIX:-is1abCTF}

          echo "æª¢æŸ¥ Flag æ ¼å¼: ${FLAG_PREFIX}{...}"

          FOUND_FLAGS=$(grep -r "${FLAG_PREFIX}{" public-release/ 2>/dev/null || true)

          if [ -n "$FOUND_FLAGS" ]; then
            echo "::error::åœ¨å…¬é–‹ç‰ˆæœ¬ä¸­ç™¼ç¾ Flag æ´©æ¼ï¼"
            echo "$FOUND_FLAGS"
            exit 1
          fi

          # æª¢æŸ¥æ•æ„Ÿæª”æ¡ˆ
          FOUND_PRIVATE=$(find public-release/ -name "private.yml" 2>/dev/null || true)
          if [ -n "$FOUND_PRIVATE" ]; then
            echo "::error::ç™¼ç¾ private.yml åœ¨å…¬é–‹ç‰ˆæœ¬ä¸­ï¼"
            echo "$FOUND_PRIVATE"
            exit 1
          fi

          echo "âœ… å…¬é–‹ç‰ˆæœ¬é©—è­‰é€šé"

      - name: ğŸ“ Generate Release Notes
        id: release-notes
        run: |
          RELEASE_TAG="${{ github.event.inputs.release_tag || github.event.release.tag_name || 'latest' }}"

          cat > release-notes.md << EOF
          # IS1AB CTF ${RELEASE_TAG}

          ## ğŸ“Š é¡Œç›®çµ±è¨ˆ

          - ç¸½é¡Œç›®æ•¸: **${{ steps.stats.outputs.total }}** é¡Œ
          - Web: ${{ steps.stats.outputs.web }} é¡Œ
          - Pwn: ${{ steps.stats.outputs.pwn }} é¡Œ
          - Crypto: ${{ steps.stats.outputs.crypto }} é¡Œ
          - Reverse: ${{ steps.stats.outputs.reverse }} é¡Œ
          - Misc: ${{ steps.stats.outputs.misc }} é¡Œ

          ## ğŸ”— é€£çµ

          - ğŸ“– é¡Œç›®å±•ç¤º: https://your-org.github.io/2025-is1ab-CTF-public
          - ğŸ“¦ å…¬é–‹ Repository: https://github.com/${{ github.event.inputs.target_repo || 'your-org/2025-is1ab-CTF-public' }}

          ## ğŸ“… ç™¼å¸ƒè³‡è¨Š

          - ç™¼å¸ƒæ—¥æœŸ: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - ç™¼å¸ƒç‰ˆæœ¬: ${RELEASE_TAG}

          ## ğŸ‰ æ„Ÿè¬

          æ„Ÿè¬æ‰€æœ‰é¡Œç›®ä½œè€…èˆ‡è²¢ç»è€…ï¼

          ---

          ğŸ¤– æ­¤ Release ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
          EOF

          cat release-notes.md

      - name: ğŸ“¤ Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: public-release
          path: public-release/
          retention-days: 30

      - name: ğŸ“¤ Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
          retention-days: 30

  # ===========================================================================
  # Job 2: åŒæ­¥åˆ°å…¬é–‹ Repository
  # ===========================================================================
  sync-to-public:
    name: ğŸ“¡ åŒæ­¥åˆ°å…¬é–‹ Repository
    runs-on: ubuntu-latest
    needs: prepare-release
    if: ${{ !inputs.dry_run }}

    steps:
      - name: ğŸ“¥ Download Release Artifact
        uses: actions/download-artifact@v4
        with:
          name: public-release
          path: public-release/

      - name: ğŸ“¥ Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: ğŸ” Setup Git Credentials
        run: |
          git config --global user.name "IS1AB Bot"
          git config --global user.email "bot@is1ab.org"

      - name: ğŸ“¡ Sync to Public Repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          TARGET_REPO="${{ github.event.inputs.target_repo || 'your-org/2025-is1ab-CTF-public' }}"
          RELEASE_TAG="${{ github.event.inputs.release_tag || github.event.release.tag_name || 'latest' }}"

          echo "ğŸ“¡ åŒæ­¥åˆ°å…¬é–‹ Repository: $TARGET_REPO"
          echo "ğŸ“¦ Release Tag: $RELEASE_TAG"

          # Clone public repo
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${TARGET_REPO}.git public-repo
          cd public-repo

          # æ¸…ç©ºç¾æœ‰å…§å®¹ï¼ˆé™¤äº† .gitï¼‰
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # è¤‡è£½æ–°å…§å®¹
          cp -r ../public-release/* .

          # å‰µå»º .nojekyll æª”æ¡ˆï¼ˆGitHub Pagesï¼‰
          touch .nojekyll

          # Commit and push
          git add .
          git commit -m "chore: release ${RELEASE_TAG}

          ğŸ¤– Automatically generated from private repository

          Release Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Release Tag: ${RELEASE_TAG}

          $(cat ../release-notes.md)" || echo "No changes to commit"

          git push origin main

          echo "âœ… åŒæ­¥å®Œæˆ"

      - name: ğŸ·ï¸ Create Release Tag
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          TARGET_REPO="${{ github.event.inputs.target_repo || 'your-org/2025-is1ab-CTF-public' }}"
          RELEASE_TAG="${{ github.event.inputs.release_tag || github.event.release.tag_name || 'latest' }}"

          cd public-repo

          # å‰µå»º tag
          git tag -a "${RELEASE_TAG}" -m "Release ${RELEASE_TAG}"
          git push origin "${RELEASE_TAG}"

          echo "âœ… Tag å‰µå»ºå®Œæˆ: ${RELEASE_TAG}"

  # ===========================================================================
  # Job 3: éƒ¨ç½² GitHub Pages
  # ===========================================================================
  deploy-pages:
    name: ğŸŒ éƒ¨ç½² GitHub Pages
    runs-on: ubuntu-latest
    needs: sync-to-public
    if: ${{ !inputs.dry_run }}

    steps:
      - name: ğŸŒ Trigger GitHub Pages Deploy
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          TARGET_REPO="${{ github.event.inputs.target_repo || 'your-org/2025-is1ab-CTF-public' }}"

          echo "ğŸŒ è§¸ç™¼ GitHub Pages éƒ¨ç½²..."

          # è§¸ç™¼ public repo çš„ deploy-pages.yml workflow
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            https://api.github.com/repos/${TARGET_REPO}/actions/workflows/deploy-pages.yml/dispatches \
            -d '{"ref":"main"}'

          echo "âœ… GitHub Pages éƒ¨ç½²å·²è§¸ç™¼"

  # ===========================================================================
  # Job 4: ç™¼å¸ƒæ‘˜è¦
  # ===========================================================================
  summary:
    name: ğŸ“Š ç™¼å¸ƒæ‘˜è¦
    runs-on: ubuntu-latest
    needs: [prepare-release, sync-to-public, deploy-pages]
    if: always()

    steps:
      - name: ğŸ“¥ Download Release Notes
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: ğŸ“Š ç”Ÿæˆæ‘˜è¦å ±å‘Š
        run: |
          RELEASE_TAG="${{ github.event.inputs.release_tag || github.event.release.tag_name || 'latest' }}"
          TARGET_REPO="${{ github.event.inputs.target_repo || 'your-org/2025-is1ab-CTF-public' }}"

          echo "# ğŸš€ Release æ‘˜è¦å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ Release è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: \`${RELEASE_TAG}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Repository**: \`${TARGET_REPO}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“Š åŸ·è¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æº–å‚™ç™¼å¸ƒç‰ˆæœ¬ | ${{ needs.prepare-release.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åŒæ­¥åˆ°å…¬é–‹ Repo | ${{ needs.sync-to-public.result == 'success' && 'âœ… æˆåŠŸ' || needs.sync-to-public.result == 'skipped' && 'â­ï¸ è·³é' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½² Pages | ${{ needs.deploy-pages.result == 'success' && 'âœ… æˆåŠŸ' || needs.deploy-pages.result == 'skipped' && 'â­ï¸ è·³é' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f release-notes.md ]; then
            echo "## ğŸ“ Release Notes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat release-notes.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”— ç›¸é—œé€£çµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [å…¬é–‹ Repository](https://github.com/${TARGET_REPO})" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages](https://$(echo ${TARGET_REPO} | cut -d'/' -f1).github.io/$(echo ${TARGET_REPO} | cut -d'/' -f2))" >> $GITHUB_STEP_SUMMARY

      - name: âŒ æª¢æŸ¥å¤±æ•—æ¢ä»¶
        if: needs.prepare-release.result == 'failure' || needs.sync-to-public.result == 'failure'
        run: |
          echo "::error::Release æµç¨‹å¤±æ•—ï¼è«‹æª¢æŸ¥ä¸Šè¿°éŒ¯èª¤è¨Šæ¯ã€‚"
          exit 1
