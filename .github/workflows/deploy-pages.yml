# =============================================================================
# ğŸŒ Deploy GitHub Pages Workflow
# =============================================================================
# åŠŸèƒ½ï¼š
# 1. ç”Ÿæˆéœæ…‹é¡Œç›®å±•ç¤ºç¶²ç«™
# 2. è‡ªå‹•ç”¢ç”Ÿé¡Œç›®ç´¢å¼•
# 3. éƒ¨ç½²åˆ° GitHub Pages
# 4. æ”¯æ´è‡ªè¨‚ä¸»é¡Œå’Œé…ç½®
# =============================================================================

name: ğŸŒ Deploy GitHub Pages

on:
  # ç•¶ public-release ç›®éŒ„æœ‰è®Šæ›´æ™‚è§¸ç™¼
  push:
    branches: [ main ]
    paths:
      - 'public-release/**'
      - 'scripts/generate-pages.py'
      - '.github/workflows/deploy-pages.yml'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      theme:
        description: 'ç¶²ç«™ä¸»é¡Œ'
        required: false
        default: 'dark'
        type: choice
        options:
          - dark
          - light
      source_dir:
        description: 'ä¾†æºç›®éŒ„'
        required: false
        default: 'public-release'
        type: string
      include_challenges:
        description: 'æ˜¯å¦å¾ challenges ç›®éŒ„ç”Ÿæˆï¼ˆç”¨æ–¼é è¦½ï¼‰'
        required: false
        default: 'false'
        type: boolean

# è¨­å®š GitHub Pages æ¬Šé™
permissions:
  contents: read
  pages: write
  id-token: write

# é˜²æ­¢ä¸¦è¡Œéƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Job 1: å»ºç½®ç¶²ç«™
  # ===========================================================================
  build:
    name: ğŸ”¨ å»ºç½®ç¶²ç«™
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python with uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true
      
      - name: ğŸ“¦ Install dependencies
        run: |
          uv venv
          uv pip install pyyaml
      
      - name: ğŸ“‹ æª¢æŸ¥ä¾†æºç›®éŒ„
        id: check-source
        run: |
          SOURCE_DIR="${{ github.event.inputs.source_dir || 'public-release' }}"
          
          # å¦‚æœé¸æ“‡å¾ challenges ç”Ÿæˆï¼ˆé è¦½æ¨¡å¼ï¼‰
          if [ "${{ github.event.inputs.include_challenges }}" = "true" ]; then
            SOURCE_DIR="challenges"
          fi
          
          echo "source_dir=$SOURCE_DIR" >> $GITHUB_OUTPUT
          
          if [ -d "$SOURCE_DIR" ]; then
            CHALLENGE_COUNT=$(find "$SOURCE_DIR" -name "public.yml" | wc -l)
            echo "æ‰¾åˆ° $CHALLENGE_COUNT å€‹é¡Œç›®"
            echo "has_challenges=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ä¾†æºç›®éŒ„ä¸å­˜åœ¨: $SOURCE_DIR"
            echo "has_challenges=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ”’ å®‰å…¨æƒæ
        if: steps.check-source.outputs.has_challenges == 'true'
        run: |
          echo "ğŸ”’ åŸ·è¡Œå®‰å…¨æƒæ..."
          
          SOURCE_DIR="${{ steps.check-source.outputs.source_dir }}"
          FLAG_PREFIX=$(grep -E "^\s*flag_prefix:" config.yml 2>/dev/null | awk -F'"' '{print $2}' | head -1)
          FLAG_PREFIX=${FLAG_PREFIX:-is1abCTF}
          
          # æƒæ Flag
          if grep -rq "${FLAG_PREFIX}{[^}]*}" "$SOURCE_DIR" --include="*.html" --include="*.md" --include="*.yml" 2>/dev/null; then
            echo "::error::ç™¼ç¾ Flag æ´©æ¼ï¼ä¸­æ­¢éƒ¨ç½²ã€‚"
            exit 1
          fi
          
          echo "âœ… å®‰å…¨æƒæé€šé"
      
      - name: ğŸŒ ç”Ÿæˆç¶²ç«™
        if: steps.check-source.outputs.has_challenges == 'true'
        run: |
          SOURCE_DIR="${{ steps.check-source.outputs.source_dir }}"
          THEME="${{ github.event.inputs.theme || 'dark' }}"
          
          echo "ğŸŒ ç”Ÿæˆ GitHub Pages..."
          echo "   ä¾†æº: $SOURCE_DIR"
          echo "   ä¸»é¡Œ: $THEME"
          
          uv run python scripts/generate-pages.py \
            --input "$SOURCE_DIR" \
            --output _site \
            --theme "$THEME" \
            --config config.yml
          
          echo "âœ… ç¶²ç«™ç”Ÿæˆå®Œæˆ"
      
      - name: ğŸ“ ç”Ÿæˆç©ºç™½é é¢ï¼ˆç„¡é¡Œç›®æ™‚ï¼‰
        if: steps.check-source.outputs.has_challenges != 'true'
        run: |
          mkdir -p _site
          
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CTF Challenge Archive</title>
              <style>
                  body {
                      font-family: system-ui, -apple-system, sans-serif;
                      background: #1a1a2e;
                      color: #eee;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                      min-height: 100vh;
                      margin: 0;
                      text-align: center;
                  }
                  .container {
                      padding: 2rem;
                  }
                  h1 { color: #e94560; }
                  p { color: #aaa; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸš© CTF Challenge Archive</h1>
                  <p>å°šç„¡å…¬é–‹é¡Œç›®ã€‚è«‹ç­‰å¾…æ¯”è³½çµæŸå¾Œç™¼å¸ƒã€‚</p>
              </div>
          </body>
          </html>
          EOF
          
          echo "ğŸ“ å·²ç”Ÿæˆé è¨­é é¢"
      
      - name: ğŸ“Š ç”Ÿæˆå»ºç½®è³‡è¨Š
        run: |
          cat > _site/build-info.json << EOF
          {
            "built_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
            "source_dir": "${{ steps.check-source.outputs.source_dir }}",
            "theme": "${{ github.event.inputs.theme || 'dark' }}",
            "commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_number }}"
          }
          EOF
      
      - name: ğŸ“¤ ä¸Šå‚³ Pages ç”¢ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  # ===========================================================================
  # Job 2: éƒ¨ç½²åˆ° GitHub Pages
  # ===========================================================================
  deploy:
    name: ğŸš€ éƒ¨ç½² Pages
    runs-on: ubuntu-latest
    needs: build
    
    # æŒ‡å®šéƒ¨ç½²ç’°å¢ƒ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: ğŸ“ è¼¸å‡ºéƒ¨ç½² URL
        run: |
          echo "ğŸ‰ ç¶²ç«™å·²éƒ¨ç½²ï¼"
          echo "ğŸ“ URL: ${{ steps.deployment.outputs.page_url }}"

  # ===========================================================================
  # Job 3: éƒ¨ç½²å¾Œé©—è­‰
  # ===========================================================================
  verify:
    name: âœ… é©—è­‰éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ğŸ” æª¢æŸ¥ç¶²ç«™ç‹€æ…‹
        run: |
          echo "ğŸ” é©—è­‰ç¶²ç«™éƒ¨ç½²..."
          
          # å–å¾— Pages URL
          PAGES_URL="${{ needs.deploy.outputs.page_url || format('https://{0}.github.io/{1}/', github.repository_owner, github.event.repository.name) }}"
          
          echo "æª¢æŸ¥ URL: $PAGES_URL"
          
          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 30
          
          # æª¢æŸ¥é¦–é 
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PAGES_URL" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… ç¶²ç«™æ­£å¸¸é‹ä½œ (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ ç¶²ç«™å›æ‡‰ç•°å¸¸ (HTTP $HTTP_STATUS)"
          fi
      
      - name: ğŸ”’ å®‰å…¨é©—è­‰
        continue-on-error: true
        run: |
          PAGES_URL="${{ needs.deploy.outputs.page_url || format('https://{0}.github.io/{1}/', github.repository_owner, github.event.repository.name) }}"
          
          echo "ğŸ”’ æª¢æŸ¥éƒ¨ç½²çš„ç¶²ç«™æ˜¯å¦æœ‰ Flag æ´©æ¼..."
          
          # ä¸‹è¼‰é¦–é æª¢æŸ¥
          PAGE_CONTENT=$(curl -s "$PAGES_URL" || echo "")
          
          # æª¢æŸ¥å¸¸è¦‹çš„ Flag æ ¼å¼
          if echo "$PAGE_CONTENT" | grep -qE "[A-Za-z0-9_]+CTF\{[^}]+\}"; then
            echo "::error::è­¦å‘Šï¼šç¶²ç«™å¯èƒ½åŒ…å« Flagï¼"
            exit 1
          fi
          
          echo "âœ… æœªç™¼ç¾ Flag æ´©æ¼"

  # ===========================================================================
  # Job 4: é€šçŸ¥
  # ===========================================================================
  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build, deploy, verify]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²æ‘˜è¦
        run: |
          echo "# ğŸŒ GitHub Pages éƒ¨ç½²å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š éƒ¨ç½²ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| éšæ®µ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å»ºç½® | ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½² | ${{ needs.deploy.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é©—è­‰ | ${{ needs.verify.result == 'success' && 'âœ… é€šé' || 'âš ï¸ è­¦å‘Š' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â„¹ï¸ éƒ¨ç½²è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸»é¡Œ**: ${{ github.event.inputs.theme || 'dark' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¾†æºç›®éŒ„**: ${{ github.event.inputs.source_dir || 'public-release' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "## ğŸ”— ç¶²ç«™é€£çµ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‘‰ [æŸ¥çœ‹ç¶²ç«™](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¢ Slack é€šçŸ¥
        if: env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            STATUS="âœ… æˆåŠŸ"
            COLOR="good"
          else
            STATUS="âŒ å¤±æ•—"
            COLOR="danger"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"title\": \"ğŸŒ GitHub Pages éƒ¨ç½² ${STATUS}\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"ä¸»é¡Œ\", \"value\": \"${{ github.event.inputs.theme || 'dark' }}\", \"short\": true}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL"

# =============================================================================
# ä½¿ç”¨èªªæ˜
# =============================================================================
# 
# è‡ªå‹•è§¸ç™¼ï¼š
# - ç•¶ public-release/ ç›®éŒ„æœ‰è®Šæ›´æ™‚è‡ªå‹•è§¸ç™¼
# - ç•¶ scripts/generate-pages.py æ›´æ–°æ™‚è§¸ç™¼
# 
# æ‰‹å‹•è§¸ç™¼ï¼š
# 1. å‰å¾€ Actions é é¢
# 2. é¸æ“‡ "Deploy GitHub Pages" workflow
# 3. é»æ“Š "Run workflow"
# 4. é¸æ“‡ä¸»é¡Œå’Œä¾†æºç›®éŒ„
# 
# è¨­å®š GitHub Pagesï¼š
# 1. å‰å¾€ Repository Settings
# 2. é¸æ“‡ Pages
# 3. Source é¸æ“‡ "GitHub Actions"
# 
# æ‰€éœ€ Secretsï¼ˆå¯é¸ï¼‰ï¼š
# - SLACK_WEBHOOK_URL: Slack é€šçŸ¥ Webhook URL
# =============================================================================

