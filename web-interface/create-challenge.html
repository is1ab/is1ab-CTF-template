<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µå»ºé¡Œç›® - IS1AB CTF ç®¡ç†ä»‹é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-shield-check"></i> IS1AB CTF ç®¡ç†
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-house"></i> é¦–é 
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="create-challenge.html">
                            <i class="bi bi-plus-circle"></i> å‰µå»ºé¡Œç›®
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="progress.html">
                            <i class="bi bi-graph-up"></i> é€²åº¦æŸ¥çœ‹
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-6">
                    <i class="bi bi-plus-circle text-success"></i> å‰µå»ºæ–°é¡Œç›®
                </h1>
                <p class="lead text-muted">å¡«å¯«è¡¨å–®ä¾†å‰µå»ºæ–°çš„ CTF é¡Œç›®</p>
            </div>
        </div>

        <!-- è¡¨å–®é€²åº¦æŒ‡ç¤ºå™¨ -->
        <div class="row mb-4">
            <div class="col">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar bg-success" id="formProgress" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2 small text-muted">
                    <span>åŸºæœ¬è³‡è¨Š</span>
                    <span>é¡Œç›®è¨­å®š</span>
                    <span>å®Œæˆ</span>
                </div>
            </div>
        </div>

        <!-- å‰µå»ºè¡¨å–® -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-form"></i> é¡Œç›®è³‡è¨Š
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="challengeForm" novalidate>
                            <!-- Step 1: åŸºæœ¬è³‡è¨Š -->
                            <div class="form-step active" id="step1">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-info-circle"></i> åŸºæœ¬è³‡è¨Š
                                </h6>
                                
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="challengeName" class="form-label">
                                            <i class="bi bi-tag"></i> é¡Œç›®åç¨± <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="challengeName" name="name" required
                                               placeholder="ä¾‹å¦‚: sql_injection_basic" pattern="^[a-z0-9_]+$">
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> åƒ…èƒ½ä½¿ç”¨å°å¯«å­—æ¯ã€æ•¸å­—å’Œåº•ç·š
                                        </div>
                                        <div class="invalid-feedback">è«‹è¼¸å…¥æœ‰æ•ˆçš„é¡Œç›®åç¨±</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="challengeAuthor" class="form-label">
                                            <i class="bi bi-person"></i> ä½œè€…
                                        </label>
                                        <input type="text" class="form-control" id="challengeAuthor" name="author" value="GZTime">
                                        <div class="invalid-feedback">è«‹è¼¸å…¥ä½œè€…åç¨±</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="challengeCategory" class="form-label">
                                            <i class="bi bi-folder"></i> åˆ†é¡ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="challengeCategory" name="category" required>
                                            <option value="">é¸æ“‡åˆ†é¡</option>
                                            <option value="web">ğŸŒ Web</option>
                                            <option value="pwn">ğŸ’¥ Pwn</option>
                                            <option value="reverse">ğŸ”„ Reverse</option>
                                            <option value="crypto">ğŸ” Crypto</option>
                                            <option value="forensic">ğŸ” Forensic</option>
                                            <option value="misc">ğŸ¯ Misc</option>
                                            <option value="general">ğŸ“‹ General</option>
                                        </select>
                                        <div class="invalid-feedback">è«‹é¸æ“‡é¡Œç›®åˆ†é¡</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="challengeDifficulty" class="form-label">
                                            <i class="bi bi-bar-chart"></i> é›£åº¦ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="challengeDifficulty" name="difficulty" required>
                                            <option value="">é¸æ“‡é›£åº¦</option>
                                            <option value="baby">ğŸ¼ Baby (50åˆ†)</option>
                                            <option value="easy">â­ Easy (100åˆ†)</option>
                                            <option value="middle">â­â­ Middle (200åˆ†)</option>
                                            <option value="hard">â­â­â­ Hard (300åˆ†)</option>
                                            <option value="impossible">ğŸ’€ Impossible (500åˆ†)</option>
                                        </select>
                                        <div class="invalid-feedback">è«‹é¸æ“‡é¡Œç›®é›£åº¦</div>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="challengeType" class="form-label">
                                            <i class="bi bi-gear"></i> é¡Œç›®é¡å‹ <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="challengeType" name="challenge_type" required>
                                            <option value="">é¸æ“‡é¡å‹</option>
                                            <option value="static_attachment">ğŸ“ éœæ…‹é™„ä»¶</option>
                                            <option value="static_container">ğŸ³ éœæ…‹å®¹å™¨</option>
                                            <option value="dynamic_attachment">ğŸ“‹ å‹•æ…‹é™„ä»¶</option>
                                            <option value="dynamic_container">ğŸ”„ å‹•æ…‹å®¹å™¨</option>
                                            <option value="nc_challenge">ğŸ”Œ NC é¡Œç›®</option>
                                        </select>
                                        <div class="invalid-feedback">è«‹é¸æ“‡é¡Œç›®é¡å‹</div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="sourceCodeProvided" name="source_code_provided">
                                            <label class="form-check-label" for="sourceCodeProvided">
                                                <i class="bi bi-file-code"></i> æä¾›åŸå§‹ç¢¼çµ¦åƒè³½è€…
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> å‹¾é¸è¡¨ç¤ºæœƒå°‡æºç¢¼ä½œç‚ºé™„ä»¶æä¾›
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        ä¸‹ä¸€æ­¥ <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: è©³ç´°è¨­å®š -->
                            <div class="form-step" id="step2">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-gear"></i> è©³ç´°è¨­å®š
                                </h6>
                                
                                <div class="mb-3">
                                    <label for="challengeDescription" class="form-label">
                                        <i class="bi bi-card-text"></i> é¡Œç›®æè¿° <span class="text-danger">*</span>
                                    </label>
                                    <textarea class="form-control" id="challengeDescription" name="description" rows="4" required
                                              placeholder="æè¿°é¡Œç›®èƒŒæ™¯ã€ç›®æ¨™å’Œçµ¦åƒè³½è€…çš„æç¤º..."></textarea>
                                    <div class="form-text">
                                        <i class="bi bi-markdown"></i> æ”¯æ´ Markdown æ ¼å¼
                                    </div>
                                    <div class="invalid-feedback">è«‹è¼¸å…¥é¡Œç›®æè¿°</div>
                                </div>

                                <div class="mb-3">
                                    <label for="challengeTags" class="form-label">
                                        <i class="bi bi-tags"></i> æ¨™ç±¤
                                    </label>
                                    <input type="text" class="form-control" id="challengeTags" name="tags"
                                           placeholder="ä¾‹å¦‚: sql-injection, authentication, beginner">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> ä»¥é€—è™Ÿåˆ†éš”å¤šå€‹æ¨™ç±¤
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="learningObjectives" class="form-label">
                                        <i class="bi bi-bullseye"></i> å­¸ç¿’ç›®æ¨™
                                    </label>
                                    <textarea class="form-control" id="learningObjectives" name="learning_objectives" rows="3"
                                              placeholder="é€™å€‹é¡Œç›®å¸Œæœ›å­¸ç”Ÿå­¸åˆ°ä»€éº¼æŠ€èƒ½æˆ–æ¦‚å¿µï¼Ÿ"></textarea>
                                </div>

                                <!-- NC é¡Œç›®ç‰¹æ®Šè¨­å®š -->
                                <div id="ncSettings" class="d-none">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> <strong>NC é¡Œç›®è¨­å®š</strong>
                                        <p class="mb-0 mt-1">æ­¤é¡å‹é¡Œç›®å°‡é€šé netcat é€£ç·šï¼Œé©åˆ PWN å’Œ Reverse é¡Œç›®ã€‚</p>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="ncPort" class="form-label">
                                                <i class="bi bi-plug"></i> é€£ç·šç«¯å£
                                            </label>
                                            <input type="number" class="form-control" id="ncPort" name="nc_port" value="9999" min="1024" max="65535">
                                            <div class="form-text">é è¨­ä½¿ç”¨ 9999 ç«¯å£</div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="ncTimeout" class="form-label">
                                                <i class="bi bi-clock"></i> é€£ç·šè¶…æ™‚ (ç§’)
                                            </label>
                                            <input type="number" class="form-control" id="ncTimeout" name="nc_timeout" value="60" min="10" max="300">
                                            <div class="form-text">é€£ç·šè‡ªå‹•æ–·é–‹æ™‚é–“</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">
                                        <i class="bi bi-arrow-left"></i> ä¸Šä¸€æ­¥
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        ä¸‹ä¸€æ­¥ <i class="bi bi-arrow-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 3: ç¢ºèªèˆ‡æäº¤ -->
                            <div class="form-step" id="step3">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-check-circle"></i> ç¢ºèªè³‡è¨Š
                                </h6>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> <strong>è«‹ç¢ºèªä»¥ä¸‹è³‡è¨Šç„¡èª¤</strong>
                                    <p class="mb-0 mt-1">æäº¤å¾Œå°‡å»ºç«‹é¡Œç›®ç›®éŒ„çµæ§‹å’Œç›¸é—œæª”æ¡ˆã€‚</p>
                                </div>

                                <div id="reviewInfo" class="mb-4">
                                    <!-- å°‡é€šé JavaScript å‹•æ…‹å¡«å…¥ -->
                                </div>

                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> <strong>æ³¨æ„äº‹é …</strong>
                                    <ul class="mb-0 mt-1">
                                        <li>é¡Œç›®å‰µå»ºå¾Œæœƒè‡ªå‹•å‰µå»º Git åˆ†æ”¯</li>
                                        <li>è«‹åœ¨ <code>src/</code> ç›®éŒ„é–‹ç™¼é¡Œç›®å…§å®¹</li>
                                        <li>å®Œæˆå¾Œæäº¤ Pull Request é€²è¡Œå¯©æ ¸</li>
                                        <li>NC é¡Œç›®éœ€è¦ç·¨è­¯ä¸¦è¤‡è£½åŸ·è¡Œæª”åˆ° <code>docker/bin/</code></li>
                                    </ul>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" onclick="prevStep()">
                                        <i class="bi bi-arrow-left"></i> ä¸Šä¸€æ­¥
                                    </button>
                                    <button type="submit" class="btn btn-success" id="submitBtn">
                                        <i class="bi bi-check"></i> å‰µå»ºé¡Œç›®
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- å´é‚Šæ¬„ -->
            <div class="col-lg-4">
                <!-- å¹«åŠ©è³‡è¨Š -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle"></i> å¹«åŠ©è³‡è¨Š
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="helpContent">
                            <h6>é¡Œç›®å‘½åè¦ç¯„</h6>
                            <ul class="small">
                                <li>ä½¿ç”¨å°å¯«å­—æ¯å’Œåº•ç·š</li>
                                <li>ç°¡æ½”æ˜ç­ï¼Œæè¿°é¡Œç›®ç‰¹æ€§</li>
                                <li>ä¾‹å¦‚: <code>sql_injection_basic</code></li>
                            </ul>

                            <h6>é¡Œç›®é¡å‹èªªæ˜</h6>
                            <ul class="small">
                                <li><strong>éœæ…‹é™„ä»¶</strong>: æª”æ¡ˆä¸‹è¼‰é¡Œç›®</li>
                                <li><strong>éœæ…‹å®¹å™¨</strong>: Web æ‡‰ç”¨é¡Œç›®</li>
                                <li><strong>å‹•æ…‹é™„ä»¶</strong>: å€‹äººåŒ–é™„ä»¶</li>
                                <li><strong>å‹•æ…‹å®¹å™¨</strong>: ç¨ç«‹å®¹å™¨å¯¦ä¾‹</li>
                                <li><strong>NC é¡Œç›®</strong>: netcat é€£ç·šé¡Œç›®</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿç¯„æœ¬ -->
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning"></i> å¿«é€Ÿç¯„æœ¬
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="applyTemplate('web-basic')">
                                <i class="bi bi-globe"></i> Web åŸºç¤é¡Œç›®
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="applyTemplate('pwn-basic')">
                                <i class="bi bi-bug"></i> PWN åŸºç¤é¡Œç›®
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="applyTemplate('crypto-basic')">
                                <i class="bi bi-shield-lock"></i> å¯†ç¢¼å­¸é¡Œç›®
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="applyTemplate('forensic-basic')">
                                <i class="bi bi-search"></i> é‘‘è­˜é¡Œç›®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸ Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> é¡Œç›®å‰µå»ºæˆåŠŸï¼
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="successMessage">
                        <!-- å°‡é€šé JavaScript å‹•æ…‹å¡«å…¥ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="goToChallenge()">
                        æŸ¥çœ‹é¡Œç›®
                    </button>
                    <button type="button" class="btn btn-primary" onclick="createAnother()">
                        å‰µå»ºå¦ä¸€å€‹
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api.js"></script>
    <script>
        let currentStep = 1;
        let challengeData = {};

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
            updateProgress();
        });

        // åˆå§‹åŒ–è¡¨å–®
        function initializeForm() {
            // æ ¹æ“šåˆ†é¡è‡ªå‹•é¸æ“‡é¡Œç›®é¡å‹
            document.getElementById('challengeCategory').addEventListener('change', function() {
                const category = this.value;
                const typeSelect = document.getElementById('challengeType');
                
                if (category === 'pwn' || category === 'reverse') {
                    typeSelect.value = 'nc_challenge';
                    showNCSettings(true);
                } else if (category === 'web') {
                    typeSelect.value = 'static_container';
                    showNCSettings(false);
                } else {
                    typeSelect.value = 'static_attachment';
                    showNCSettings(false);
                }
            });

            // é¡Œç›®é¡å‹è®Šæ›´æ™‚é¡¯ç¤º/éš±è— NC è¨­å®š
            document.getElementById('challengeType').addEventListener('change', function() {
                showNCSettings(this.value === 'nc_challenge');
            });
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¡¨å–®é©—è­‰
            const form = document.getElementById('challengeForm');
            form.addEventListener('submit', handleFormSubmit);

            // å³æ™‚é©—è­‰
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', validateField);
                input.addEventListener('blur', validateField);
            });
        }

        // é¡¯ç¤º/éš±è— NC è¨­å®š
        function showNCSettings(show) {
            const ncSettings = document.getElementById('ncSettings');
            if (show) {
                ncSettings.classList.remove('d-none');
            } else {
                ncSettings.classList.add('d-none');
            }
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 3) {
                    // éš±è—ç•¶å‰æ­¥é©Ÿ
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    
                    // é¡¯ç¤ºä¸‹ä¸€æ­¥é©Ÿ
                    currentStep++;
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    
                    // æ›´æ–°é€²åº¦
                    updateProgress();
                    
                    // å¦‚æœæ˜¯æœ€å¾Œä¸€æ­¥ï¼Œæ›´æ–°é è¦½
                    if (currentStep === 3) {
                        updateReviewInfo();
                    }
                }
            }
        }

        // ä¸Šä¸€æ­¥
        function prevStep() {
            if (currentStep > 1) {
                // éš±è—ç•¶å‰æ­¥é©Ÿ
                document.getElementById(`step${currentStep}`).classList.remove('active');
                
                // é¡¯ç¤ºä¸Šä¸€æ­¥é©Ÿ
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                
                // æ›´æ–°é€²åº¦
                updateProgress();
            }
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress() {
            const progress = (currentStep - 1) / 2 * 100;
            document.getElementById('formProgress').style.width = `${progress}%`;
        }

        // é©—è­‰ç•¶å‰æ­¥é©Ÿ
        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!validateField({ target: field })) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // é©—è­‰å–®å€‹æ¬„ä½
        function validateField(event) {
            const field = event.target;
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';

            // ç§»é™¤ä¹‹å‰çš„é©—è­‰ç‹€æ…‹
            field.classList.remove('is-valid', 'is-invalid');

            // å¿…å¡«æ¬„ä½æª¢æŸ¥
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = `${field.labels[0]?.textContent || field.name} ç‚ºå¿…å¡«æ¬„ä½`;
            }

            // ç‰¹æ®Šé©—è­‰è¦å‰‡
            if (field.name === 'name' && value) {
                const pattern = /^[a-z0-9_]+$/;
                if (!pattern.test(value)) {
                    isValid = false;
                    errorMessage = 'é¡Œç›®åç¨±åªèƒ½åŒ…å«å°å¯«å­—æ¯ã€æ•¸å­—å’Œåº•ç·š';
                } else if (value.length < 3) {
                    isValid = false;
                    errorMessage = 'é¡Œç›®åç¨±è‡³å°‘éœ€è¦ 3 å€‹å­—å…ƒ';
                } else if (value.length > 50) {
                    isValid = false;
                    errorMessage = 'é¡Œç›®åç¨±ä¸èƒ½è¶…é 50 å€‹å­—å…ƒ';
                }
            }

            if (field.name === 'description' && value && value.length < 10) {
                isValid = false;
                errorMessage = 'é¡Œç›®æè¿°è‡³å°‘éœ€è¦ 10 å€‹å­—å…ƒ';
            }

            // è¨­å®šé©—è­‰ç‹€æ…‹
            if (value || field.hasAttribute('required')) {
                field.classList.add(isValid ? 'is-valid' : 'is-invalid');
                
                // æ›´æ–°éŒ¯èª¤è¨Šæ¯
                const feedback = field.parentElement.querySelector('.invalid-feedback');
                if (feedback && errorMessage) {
                    feedback.textContent = errorMessage;
                }
            }

            return isValid;
        }

        // æ›´æ–°é è¦½è³‡è¨Š
        function updateReviewInfo() {
            const formData = new FormData(document.getElementById('challengeForm'));
            const data = Object.fromEntries(formData.entries());
            
            // è™•ç†æ¨™ç±¤
            if (data.tags) {
                data.tags = data.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            }

            const reviewHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">åŸºæœ¬è³‡è¨Š</h6>
                        <table class="table table-sm">
                            <tr><td><strong>é¡Œç›®åç¨±:</strong></td><td>${data.name || 'æœªè¨­å®š'}</td></tr>
                            <tr><td><strong>ä½œè€…:</strong></td><td>${data.author || 'æœªè¨­å®š'}</td></tr>
                            <tr><td><strong>åˆ†é¡:</strong></td><td>${getCategoryName(data.category)}</td></tr>
                            <tr><td><strong>é›£åº¦:</strong></td><td>${getDifficultyName(data.difficulty)}</td></tr>
                            <tr><td><strong>é¡å‹:</strong></td><td>${getTypeName(data.challenge_type)}</td></tr>
                            <tr><td><strong>åŸå§‹ç¢¼:</strong></td><td>${data.source_code_provided ? 'âœ… æä¾›' : 'âŒ ä¸æä¾›'}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">è©³ç´°è¨­å®š</h6>
                        <table class="table table-sm">
                            <tr><td><strong>æè¿°:</strong></td><td>${data.description ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}</td></tr>
                            <tr><td><strong>æ¨™ç±¤:</strong></td><td>${data.tags ? data.tags.join(', ') : 'ç„¡'}</td></tr>
                            <tr><td><strong>å­¸ç¿’ç›®æ¨™:</strong></td><td>${data.learning_objectives ? 'å·²è¨­å®š' : 'æœªè¨­å®š'}</td></tr>
                            ${data.challenge_type === 'nc_challenge' ? `
                                <tr><td><strong>NC ç«¯å£:</strong></td><td>${data.nc_port || '9999'}</td></tr>
                                <tr><td><strong>è¶…æ™‚æ™‚é–“:</strong></td><td>${data.nc_timeout || '60'} ç§’</td></tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('reviewInfo').innerHTML = reviewHtml;
            challengeData = data;
        }

        // è™•ç†è¡¨å–®æäº¤
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> å‰µå»ºä¸­...';

                // æº–å‚™è³‡æ–™
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());
                
                // è™•ç†å¸ƒæ—å€¼
                data.source_code_provided = data.source_code_provided === 'on';
                
                // è™•ç†æ¨™ç±¤
                if (data.tags) {
                    data.tags = data.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                }

                // é©—è­‰è³‡æ–™
                const validation = utils.validateChallengeForm(data);
                if (!validation.isValid) {
                    throw new Error(validation.errors.join('\n'));
                }

                // å‘¼å« API
                const result = await api.createChallenge(data);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showSuccessModal(data, result);
                
            } catch (error) {
                console.error('å‰µå»ºå¤±æ•—:', error);
                showToast('å‰µå»ºå¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // é¡¯ç¤ºæˆåŠŸ Modal
        function showSuccessModal(data, result) {
            const message = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> é¡Œç›® "${data.name}" å‰µå»ºæˆåŠŸï¼</h6>
                    <p class="mb-1">å·²è‡ªå‹•å‰µå»ºä»¥ä¸‹å…§å®¹ï¼š</p>
                    <ul class="mb-0">
                        <li>é¡Œç›®ç›®éŒ„çµæ§‹</li>
                        <li>Docker é…ç½®æª”æ¡ˆ</li>
                        <li>README æ¨¡æ¿</li>
                        <li>Writeup æ¨¡æ¿</li>
                        ${data.challenge_type === 'nc_challenge' ? '<li>NC é¡Œç›®è…³æœ¬</li>' : ''}
                        <li>Git åˆ†æ”¯: challenge/${data.category}/${data.name}</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('successMessage').innerHTML = message;
            challengeData.result = result;
            
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }

        // å‰å¾€é¡Œç›®
        function goToChallenge() {
            if (challengeData.result && challengeData.result.path) {
                // åœ¨å¯¦éš›ç’°å¢ƒä¸­ï¼Œé€™è£¡å¯ä»¥é–‹å•Ÿæª”æ¡ˆç®¡ç†å™¨æˆ–ç·¨è¼¯å™¨
                showToast('æç¤º', `é¡Œç›®ä½æ–¼: ${challengeData.result.path}`, 'info');
            }
        }

        // å‰µå»ºå¦ä¸€å€‹é¡Œç›®
        function createAnother() {
            // é‡ç½®è¡¨å–®
            document.getElementById('challengeForm').reset();
            currentStep = 1;
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
            updateProgress();
            
            // é—œé–‰ Modal
            bootstrap.Modal.getInstance(document.getElementById('successModal')).hide();
            
            showToast('å·²é‡ç½®', 'è¡¨å–®å·²é‡ç½®ï¼Œå¯ä»¥å‰µå»ºæ–°é¡Œç›®', 'success');
        }

        // æ‡‰ç”¨ç¯„æœ¬
        function applyTemplate(templateType) {
            const templates = {
                'web-basic': {
                    category: 'web',
                    difficulty: 'easy',
                    challenge_type: 'static_container',
                    description: 'é€™æ˜¯ä¸€å€‹åŸºç¤çš„ Web å®‰å…¨é¡Œç›®ï¼Œé©åˆåˆå­¸è€…ç·´ç¿’ã€‚',
                    tags: 'web, basic, beginner',
                    learning_objectives: 'å­¸ç¿’åŸºæœ¬çš„ Web å®‰å…¨æ¦‚å¿µå’Œæ¼æ´åˆ©ç”¨æŠ€å·§'
                },
                'pwn-basic': {
                    category: 'pwn',
                    difficulty: 'baby',
                    challenge_type: 'nc_challenge',
                    description: 'ç°¡å–®çš„ç·©è¡å€æº¢ä½é¡Œç›®ï¼Œå­¸ç¿’åŸºæœ¬çš„è¨˜æ†¶é«”å®‰å…¨æ¦‚å¿µã€‚',
                    tags: 'pwn, buffer-overflow, beginner',
                    learning_objectives: 'äº†è§£ç·©è¡å€æº¢ä½æ¼æ´çš„åŸç†å’ŒåŸºæœ¬åˆ©ç”¨æ–¹æ³•'
                },
                'crypto-basic': {
                    category: 'crypto',
                    difficulty: 'easy',
                    challenge_type: 'static_attachment',
                    description: 'å¯†ç¢¼å­¸åŸºç¤é¡Œç›®ï¼Œæ¶‰åŠå¤å…¸å¯†ç¢¼æˆ–ç¾ä»£åŠ å¯†ç®—æ³•ã€‚',
                    tags: 'crypto, encryption, basic',
                    learning_objectives: 'å­¸ç¿’åŸºæœ¬çš„å¯†ç¢¼å­¸æ¦‚å¿µå’ŒåŠ å¯†è§£å¯†æ–¹æ³•'
                },
                'forensic-basic': {
                    category: 'forensic',
                    difficulty: 'middle',
                    challenge_type: 'static_attachment',
                    description: 'æ•¸ä½é‘‘è­˜é¡Œç›®ï¼Œéœ€è¦åˆ†ææª”æ¡ˆæˆ–è¨˜æ†¶æ˜ åƒã€‚',
                    tags: 'forensic, analysis, investigation',
                    learning_objectives: 'å­¸ç¿’æ•¸ä½é‘‘è­˜æŠ€è¡“å’Œè­‰æ“šåˆ†ææ–¹æ³•'
                }
            };

            const template = templates[templateType];
            if (template) {
                // å¡«å…¥è¡¨å–®
                Object.keys(template).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = template[key];
                        
                        // è§¸ç™¼äº‹ä»¶
                        if (element.type === 'select-one') {
                            element.dispatchEvent(new Event('change'));
                        }
                    }
                });

                showToast('ç¯„æœ¬å·²å¥—ç”¨', `${templateType} ç¯„æœ¬å·²æˆåŠŸå¥—ç”¨`, 'success');
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function getCategoryName(category) {
            const names = {
                web: 'ğŸŒ Web',
                pwn: 'ğŸ’¥ Pwn',
                reverse: 'ğŸ”„ Reverse',
                crypto: 'ğŸ” Crypto',
                forensic: 'ğŸ” Forensic',
                misc: 'ğŸ¯ Misc',
                general: 'ğŸ“‹ General'
            };
            return names[category] || category;
        }

        function getDifficultyName(difficulty) {
            const names = {
                baby: 'ğŸ¼ Baby (50åˆ†)',
                easy: 'â­ Easy (100åˆ†)',
                middle: 'â­â­ Middle (200åˆ†)',
                hard: 'â­â­â­ Hard (300åˆ†)',
                impossible: 'ğŸ’€ Impossible (500åˆ†)'
            };
            return names[difficulty] || difficulty;
        }

        function getTypeName(type) {
            const names = {
                static_attachment: 'ğŸ“ éœæ…‹é™„ä»¶',
                static_container: 'ğŸ³ éœæ…‹å®¹å™¨',
                dynamic_attachment: 'ğŸ“‹ å‹•æ…‹é™„ä»¶',
                dynamic_container: 'ğŸ”„ å‹•æ…‹å®¹å™¨',
                nc_challenge: 'ğŸ”Œ NC é¡Œç›®'
            };
            return names[type] || type;
        }

        // é¡¯ç¤º Toast é€šçŸ¥
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong><br>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (document.getElementById(toastId)) {
                    toastContainer.removeChild(toast);
                }
            }, 5000);
        }
    </script>
</body>
</html>