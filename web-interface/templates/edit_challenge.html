{% extends "base.html" %}
{% set title = "ç·¨è¼¯é¡Œç›® - " + challenge.title %}

{% block content %}
<!-- é é¢æ¨™é¡Œ -->
<section class="hero is-warning is-small">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
        <i class="fas fa-edit mr-3"></i>
        ç·¨è¼¯é¡Œç›® - {{ challenge.title }}
      </h1>
      <p class="subtitle">ä¿®æ”¹ {{ challenge.category }}/{{ challenge.name }} çš„é…ç½®</p>
    </div>
  </div>
</section>

<!-- ç·¨è¼¯è¡¨å–® -->
<section class="section">
  <div class="container">
    <form id="editChallengeForm" data-category="{{ challenge.category }}" data-name="{{ challenge.name }}">
      <div class="columns">
        <!-- ä¸»è¦ç·¨è¼¯å€åŸŸ -->
        <div class="column is-two-thirds">
          <!-- åŸºæœ¬è³‡è¨Š -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon mr-2">
                  <i class="fas fa-info-circle"></i>
                </span>
                åŸºæœ¬è³‡è¨Š
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <label class="label">é¡Œç›®æ¨™é¡Œ <span class="has-text-danger">*</span></label>
                <div class="control">
                  <input class="input" type="text" name="title" value="{{ challenge.title }}" required>
                </div>
              </div>

              <div class="field">
                <label class="label">é¡Œç›®æè¿° <span class="has-text-danger">*</span></label>
                <div class="control">
                  <textarea class="textarea" name="description" rows="4" required>{{ challenge.description }}</textarea>
                </div>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">åˆ†é¡ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="category" required>
                          {% for cat in config.categories %}
                          <option value="{{ cat }}" {% if cat == challenge.category %}selected{% endif %}>{{ cat }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">é›£åº¦ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="difficulty" required>
                          {% for diff in config.difficulties %}
                          <option value="{{ diff }}" {% if diff == challenge.difficulty %}selected{% endif %}>{{ diff }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">åˆ†æ•¸ <span class="has-text-danger">*</span></label>
                    <div class="control">
                      <input class="input" type="number" name="points" value="{{ challenge.points }}" min="1" max="1000" required>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">ä½œè€…</label>
                    <div class="control">
                      <input class="input" type="text" name="author" value="{{ challenge.author }}">
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">é¡Œç›®é¡å‹</label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="challenge_type">
                          <option value="static_container" {% if challenge.challenge_type == 'static_container' %}selected{% endif %}>éœæ…‹å®¹å™¨</option>
                          <option value="dynamic_container" {% if challenge.challenge_type == 'dynamic_container' %}selected{% endif %}>å‹•æ…‹å®¹å™¨</option>
                          <option value="static_attachment" {% if challenge.challenge_type == 'static_attachment' %}selected{% endif %}>éœæ…‹é™„ä»¶</option>
                          <option value="dynamic_attachment" {% if challenge.challenge_type == 'dynamic_attachment' %}selected{% endif %}>å‹•æ…‹é™„ä»¶</option>
                          <option value="nc_challenge" {% if challenge.challenge_type == 'nc_challenge' %}selected{% endif %}>NC é¡Œç›®</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">ç‹€æ…‹</label>
                    <div class="control">
                      <div class="select is-fullwidth">
                        <select name="status">
                          <option value="planning" {% if challenge.status == 'planning' %}selected{% endif %}>è¦åŠƒä¸­</option>
                          <option value="developing" {% if challenge.status == 'developing' %}selected{% endif %}>é–‹ç™¼ä¸­</option>
                          <option value="testing" {% if challenge.status == 'testing' %}selected{% endif %}>æ¸¬è©¦ä¸­</option>
                          <option value="completed" {% if challenge.status == 'completed' %}selected{% endif %}>å·²å®Œæˆ</option>
                          <option value="deployed" {% if challenge.status == 'deployed' %}selected{% endif %}>å·²éƒ¨ç½²</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="field">
                <label class="label">
                  <input type="checkbox" name="source_code_provided" {% if challenge.source_code_provided %}checked{% endif %}>
                  æä¾›åŸå§‹ç¢¼
                </label>
              </div>
            </div>
          </div>

          <!-- æç¤ºç³»çµ± -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon mr-2">
                  <i class="fas fa-lightbulb"></i>
                </span>
                æç¤ºç³»çµ±
              </p>
              <div class="card-header-icon">
                <button type="button" class="button is-small is-primary" onclick="addHint()">
                  <span class="icon">
                    <i class="fas fa-plus"></i>
                  </span>
                  <span>æ–°å¢æç¤º</span>
                </button>
              </div>
            </div>
            <div class="card-content">
              <div id="hintsContainer">
                {% for hint in challenge.hints %}
                <div class="box hint-item" data-level="{{ hint.level }}">
                  <div class="field is-grouped">
                    <div class="control">
                      <label class="label">Level</label>
                      <input class="input is-small" type="number" name="hint_level" value="{{ hint.level }}" min="1" style="width: 80px;">
                    </div>
                    <div class="control">
                      <label class="label">èŠ±è²»åˆ†æ•¸</label>
                      <input class="input is-small" type="number" name="hint_cost" value="{{ hint.cost }}" min="0" style="width: 100px;">
                    </div>
                    <div class="control ml-auto">
                      <button type="button" class="button is-small is-danger" onclick="removeHint(this)">
                        <span class="icon">
                          <i class="fas fa-trash"></i>
                        </span>
                      </button>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">æç¤ºå…§å®¹</label>
                    <div class="control">
                      <textarea class="textarea" name="hint_content" rows="3">{{ hint.content if hint.content else '' }}</textarea>
                    </div>
                  </div>
                </div>
                {% endfor %}
                {% if not challenge.hints %}
                <div class="box hint-item">
                  <div class="field is-grouped">
                    <div class="control">
                      <label class="label">Level</label>
                      <input class="input is-small" type="number" name="hint_level" value="1" min="1" style="width: 80px;">
                    </div>
                    <div class="control">
                      <label class="label">èŠ±è²»åˆ†æ•¸</label>
                      <input class="input is-small" type="number" name="hint_cost" value="0" min="0" style="width: 100px;">
                    </div>
                    <div class="control ml-auto">
                      <button type="button" class="button is-small is-danger" onclick="removeHint(this)">
                        <span class="icon">
                          <i class="fas fa-trash"></i>
                        </span>
                      </button>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">æç¤ºå…§å®¹</label>
                    <div class="control">
                      <textarea class="textarea" name="hint_content" rows="3" placeholder="è¼¸å…¥æç¤ºå…§å®¹..."></textarea>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Flag è¨­å®š -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title has-text-danger">
                <span class="icon mr-2">
                  <i class="fas fa-lock"></i>
                </span>
                Flag è¨­å®š (æ•æ„Ÿè³‡è¨Š)
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <label class="label">Flag</label>
                <div class="control">
                  <input class="input is-family-monospace" type="text" name="flag" value="{{ challenge.flag if challenge.flag else '' }}" placeholder="is1abCTF{flag_content}">
                </div>
              </div>

              <div class="field">
                <label class="label">Flag èªªæ˜</label>
                <div class="control">
                  <textarea class="textarea" name="flag_description" rows="3">{{ challenge.flag_description if challenge.flag_description else '' }}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- åŸå§‹ç¢¼æ”¾ç½®ä½ç½®æç¤º -->
          <div class="notification is-info is-light mb-4">
            <div class="content">
              <h5 class="title is-5">
                <i class="fas fa-folder-open mr-2"></i>
                é¡Œç›®æª”æ¡ˆçµæ§‹ - {{ challenge.category }}/{{ challenge.name }}
              </h5>
              <div class="columns">
                <div class="column">
                  <h6 class="subtitle is-6">ğŸ“ ç›®éŒ„èªªæ˜</h6>
                  <div class="content">
                    <ul>
                      <li><strong>src/</strong> - é¡Œç›®åŸå§‹ç¢¼ï¼ˆä¸å…¬é–‹ï¼‰</li>
                      <li><strong>files/</strong> - åƒè³½è€…ä¸‹è¼‰æª”æ¡ˆ</li>
                      <li><strong>writeup/</strong> - è§£é¡Œèªªæ˜æ–‡æª”</li>
                      <li><strong>docker/</strong> - Docker éƒ¨ç½²æª”æ¡ˆ</li>
                      <li><strong>bin/</strong> - ç·¨è­¯å¾ŒåŸ·è¡Œæª”</li>
                    </ul>
                  </div>
                </div>
                <div class="column">
                  <h6 class="subtitle is-6">ğŸ’¡ æª”æ¡ˆç®¡ç†æé†’</h6>
                  <div class="content">
                    <ul>
                      <li>ğŸ”’ åŸå§‹ç¢¼è«‹æ”¾åœ¨ <strong>src/</strong> ç›®éŒ„</li>
                      <li>ğŸ“¦ é™„ä»¶æª”æ¡ˆæ”¾åœ¨ <strong>files/</strong> ç›®éŒ„</li>
                      <li>ğŸ“ è§£é¡Œæ­¥é©Ÿå¯«åœ¨ <strong>writeup/</strong></li>
                      <li>ğŸ” å¯åœ¨é¡Œç›®è©³æƒ…é æŸ¥çœ‹æª”æ¡ˆåˆ—è¡¨</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰éˆ• -->
          <div class="field is-grouped">
            <div class="control">
              <button type="submit" class="button is-primary" id="saveBtn">
                <span class="icon">
                  <i class="fas fa-save"></i>
                </span>
                <span>å„²å­˜è®Šæ›´</span>
              </button>
            </div>
            <div class="control">
              <a href="{{ url_for('challenge_detail', category=challenge.category, name=challenge.name) }}" class="button is-light">
                <span class="icon">
                  <i class="fas fa-times"></i>
                </span>
                <span>å–æ¶ˆ</span>
              </a>
            </div>
          </div>
        </div>

        <!-- å´é‚Šæ¬„ -->
        <div class="column is-one-third">
          <!-- æ¨™ç±¤ -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon mr-2">
                  <i class="fas fa-tags"></i>
                </span>
                æ¨™ç±¤
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <div class="control">
                  <input class="input" type="text" name="tags" value="{{ challenge.tags | join(', ') if challenge.tags else '' }}" placeholder="ç”¨é€—è™Ÿåˆ†éš”æ¨™ç±¤">
                </div>
                <p class="help">ä½¿ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹æ¨™ç±¤</p>
              </div>
            </div>
          </div>

          <!-- å­¸ç¿’ç›®æ¨™ -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon mr-2">
                  <i class="fas fa-graduation-cap"></i>
                </span>
                å­¸ç¿’ç›®æ¨™
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <div class="control">
                  <textarea class="textarea" name="learning_objectives" rows="4" placeholder="æ¯è¡Œä¸€å€‹å­¸ç¿’ç›®æ¨™">{{ challenge.learning_objectives | join('\n') if challenge.learning_objectives else '' }}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- æ‰€éœ€æŠ€èƒ½ -->
          <div class="card mb-5">
            <div class="card-header">
              <p class="card-header-title">
                <span class="icon mr-2">
                  <i class="fas fa-tools"></i>
                </span>
                æ‰€éœ€æŠ€èƒ½
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <div class="control">
                  <textarea class="textarea" name="required_skills" rows="4" placeholder="æ¯è¡Œä¸€å€‹æ‰€éœ€æŠ€èƒ½">{{ challenge.required_skills | join('\n') if challenge.required_skills else '' }}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- å…§éƒ¨ç­†è¨˜ -->
          <div class="card">
            <div class="card-header">
              <p class="card-header-title has-text-warning">
                <span class="icon mr-2">
                  <i class="fas fa-sticky-note"></i>
                </span>
                å…§éƒ¨ç­†è¨˜ (ä¸å…¬é–‹)
              </p>
            </div>
            <div class="card-content">
              <div class="field">
                <div class="control">
                  <textarea class="textarea" name="internal_notes" rows="6" placeholder="é–‹ç™¼ç­†è¨˜ã€æ³¨æ„äº‹é …ç­‰...">{{ challenge.internal_notes if challenge.internal_notes else '' }}</textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</section>

<script>
// æç¤ºç®¡ç†åŠŸèƒ½
function addHint() {
  const container = document.getElementById('hintsContainer');
  const hintsCount = container.querySelectorAll('.hint-item').length;
  const newLevel = hintsCount + 1;
  
  const hintHTML = `
    <div class="box hint-item">
      <div class="field is-grouped">
        <div class="control">
          <label class="label">Level</label>
          <input class="input is-small" type="number" name="hint_level" value="${newLevel}" min="1" style="width: 80px;">
        </div>
        <div class="control">
          <label class="label">èŠ±è²»åˆ†æ•¸</label>
          <input class="input is-small" type="number" name="hint_cost" value="0" min="0" style="width: 100px;">
        </div>
        <div class="control ml-auto">
          <button type="button" class="button is-small is-danger" onclick="removeHint(this)">
            <span class="icon">
              <i class="fas fa-trash"></i>
            </span>
          </button>
        </div>
      </div>
      <div class="field">
        <label class="label">æç¤ºå…§å®¹</label>
        <div class="control">
          <textarea class="textarea" name="hint_content" rows="3" placeholder="è¼¸å…¥æç¤ºå…§å®¹..."></textarea>
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', hintHTML);
}

function removeHint(button) {
  const hintItem = button.closest('.hint-item');
  hintItem.remove();
}

// è¡¨å–®æäº¤
document.getElementById('editChallengeForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const form = e.target;
  const category = form.dataset.category;
  const name = form.dataset.name;
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.innerHTML;
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  saveBtn.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-pulse"></i></span><span>å„²å­˜ä¸­...</span>';
  saveBtn.disabled = true;
  
  // æ”¶é›†è¡¨å–®è³‡æ–™
  const formData = new FormData(form);
  const challengeData = {};
  
  // åŸºæœ¬æ¬„ä½
  for (let [key, value] of formData.entries()) {
    if (key.startsWith('hint_')) continue; // æç¤ºå–®ç¨è™•ç†
    
    if (key === 'tags') {
      challengeData[key] = value.split(',').map(tag => tag.trim()).filter(tag => tag);
    } else if (key === 'learning_objectives' || key === 'required_skills') {
      challengeData[key] = value.split('\\n').map(item => item.trim()).filter(item => item);
    } else if (key === 'source_code_provided') {
      challengeData[key] = true; // checkbox
    } else {
      challengeData[key] = value;
    }
  }
  
  // è™•ç† checkboxï¼ˆæœªå‹¾é¸æ™‚ä¸æœƒå‡ºç¾åœ¨ FormData ä¸­ï¼‰
  if (!challengeData.source_code_provided) {
    challengeData.source_code_provided = false;
  }
  
  // è™•ç†æç¤º
  const hints = [];
  const hintItems = form.querySelectorAll('.hint-item');
  hintItems.forEach(item => {
    const level = parseInt(item.querySelector('[name="hint_level"]').value);
    const cost = parseInt(item.querySelector('[name="hint_cost"]').value);
    const content = item.querySelector('[name="hint_content"]').value.trim();
    
    if (level && content) {
      hints.push({ level, cost: cost || 0, content });
    }
  });
  challengeData.hints = hints;
  
  // ç™¼é€ API è«‹æ±‚
  fetch(`/api/challenges/${category}/${name}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(challengeData),
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      alert('é¡Œç›®æ›´æ–°æˆåŠŸï¼');
      window.location.href = `/challenges/${category}/${name}`;
    } else {
      alert('æ›´æ–°å¤±æ•—ï¼š' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤');
  })
  .finally(() => {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  });
});
</script>
{% endblock %}
