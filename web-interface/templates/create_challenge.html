{% extends "base.html" %} {% set title = "å‰µå»ºæŒ‘æˆ°" %} {% block content %}
<!-- é é¢æ¨™é¡Œ -->
<section class="hero is-warning is-small">
  <div class="hero-body">
    <div class="container">
      <h1 class="title">
        <i class="fas fa-plus-circle mr-3"></i>
        å‰µå»ºæŒ‘æˆ°
      </h1>
      <p class="subtitle">å‰µå»ºæ–°çš„ CTF æŒ‘æˆ°</p>
    </div>
  </div>
</section>

<!-- å‰µå»ºè¡¨å–® -->
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-two-thirds">
        <div class="card">
          <div class="card-content">
            <form id="challengeForm">
              <!-- åŸºæœ¬è³‡è¨Š -->
              <div class="field">
                <label class="label"
                  >æŒ‘æˆ°åç¨± <span class="has-text-danger">*</span></label
                >
                <div class="control has-icons-left">
                  <input
                    class="input"
                    type="text"
                    id="challengeName"
                    name="name"
                    placeholder="è¼¸å…¥æŒ‘æˆ°åç¨±"
                    required
                  />
                  <span class="icon is-small is-left">
                    <i class="fas fa-signature"></i>
                  </span>
                </div>
              </div>

              <div class="field">
                <label class="label"
                  >æŒ‘æˆ°æè¿° <span class="has-text-danger">*</span></label
                >
                <div class="control">
                  <textarea
                    class="textarea"
                    id="challengeDescription"
                    name="description"
                    placeholder="è¼¸å…¥æŒ‘æˆ°æè¿°"
                    rows="4"
                    required
                  ></textarea>
                </div>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label"
                      >é¡åˆ¥ <span class="has-text-danger">*</span></label
                    >
                    <div class="control has-icons-left">
                      <div class="select is-fullwidth">
                        <select id="challengeCategory" name="category" required>
                          <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                          {% for category in config.categories %}
                          <option value="{{ category }}">{{ category }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <span class="icon is-small is-left">
                        <i class="fas fa-tags"></i>
                      </span>
                    </div>
                  </div>
                </div>

                <div class="column">
                  <div class="field">
                    <label class="label"
                      >é›£åº¦ <span class="has-text-danger">*</span></label
                    >
                    <div class="control has-icons-left">
                      <div class="select is-fullwidth">
                        <select
                          id="challengeDifficulty"
                          name="difficulty"
                          required
                        >
                          <option value="">è«‹é¸æ“‡é›£åº¦</option>
                          {% for difficulty in config.difficulties %}
                          <option value="{{ difficulty }}">
                            {{ difficulty }}
                          </option>
                          {% endfor %}
                        </select>
                      </div>
                      <span class="icon is-small is-left">
                        <i class="fas fa-chart-line"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label"
                      >åˆ†æ•¸ <span class="has-text-danger">*</span></label
                    >
                    <div class="control has-icons-left">
                      <input
                        class="input"
                        type="number"
                        id="challengePoints"
                        name="points"
                        placeholder="å°‡æ ¹æ“šé›£åº¦è‡ªå‹•è¨­ç½®"
                        min="1"
                        max="1000"
                        required
                      />
                      <span class="icon is-small is-left">
                        <i class="fas fa-star"></i>
                      </span>
                    </div>
                    <p class="help is-info">
                      <i class="fas fa-magic"></i>
                      é¸æ“‡é›£åº¦å¾Œå°‡è‡ªå‹•è¨­ç½®å°æ‡‰åˆ†æ•¸ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•ä¿®æ”¹
                    </p>
                  </div>
                </div>

                <div class="column">
                  <div class="field">
                    <label class="label">ä½œè€…</label>
                    <div class="control has-icons-left">
                      <input
                        class="input"
                        type="text"
                        id="challengeAuthor"
                        name="author"
                        placeholder="ä½œè€…åç¨±"
                      />
                      <span class="icon is-small is-left">
                        <i class="fas fa-user"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- é¡Œç›®é¡å‹ -->
              <div class="field">
                <label class="label">é¡Œç›®é¡å‹</label>
                <div class="control has-icons-left">
                  <div class="select is-fullwidth">
                    <select id="challengeType" name="challenge_type">
                      <option value="static_container">
                        éœæ…‹å®¹å™¨ (Static Container)
                      </option>
                      <option value="dynamic_container">
                        å‹•æ…‹å®¹å™¨ (Dynamic Container)
                      </option>
                      <option value="static_attachment">
                        éœæ…‹é™„ä»¶ (Static Attachment)
                      </option>
                      <option value="dynamic_attachment">
                        å‹•æ…‹é™„ä»¶ (Dynamic Attachment)
                      </option>
                      <option value="nc_challenge">
                        NC é¡Œç›® (Netcat Challenge)
                      </option>
                    </select>
                  </div>
                  <span class="icon is-small is-left">
                    <i class="fas fa-cube"></i>
                  </span>
                </div>
                <p class="help">é¸æ“‡é¡Œç›®çš„éƒ¨ç½²é¡å‹</p>
              </div>

              <!-- Flag è¨­å®š -->
              <div class="field">
                <label class="label">Flag</label>
                <div class="control has-icons-left">
                  <input
                    class="input"
                    type="text"
                    id="challengeFlag"
                    name="flag"
                    placeholder="flag{example_flag}"
                    pattern="flag\{.*\}"
                  />
                  <span class="icon is-small is-left">
                    <i class="fas fa-flag"></i>
                  </span>
                </div>
                <p class="help">Flag æ ¼å¼æ‡‰ç‚º flag{content}ï¼Œç•™ç©ºå°‡è‡ªå‹•ç”Ÿæˆ</p>
              </div>

              <!-- æç¤ºç³»çµ± -->
              <div class="field">
                <label class="label">æç¤ºç³»çµ±</label>
                <div class="card">
                  <div class="card-header">
                    <p class="card-header-title">
                      <span class="icon mr-2">
                        <i class="fas fa-lightbulb"></i>
                      </span>
                      æç¤º
                    </p>
                    <div class="card-header-icon">
                      <button
                        type="button"
                        class="button is-small is-primary"
                        onclick="addHintToCreate()"
                      >
                        <span class="icon">
                          <i class="fas fa-plus"></i>
                        </span>
                        <span>æ–°å¢æç¤º</span>
                      </button>
                    </div>
                  </div>
                  <div class="card-content">
                    <div id="createHintsContainer">
                      <!-- é è¨­ä¸€å€‹æç¤º -->
                      <div class="box hint-item">
                        <div class="field is-grouped">
                          <div class="control">
                            <label class="label">Level</label>
                            <input
                              class="input is-small"
                              type="number"
                              name="hint_level"
                              value="1"
                              min="1"
                              style="width: 80px"
                            />
                          </div>
                          <div class="control">
                            <label class="label">èŠ±è²»åˆ†æ•¸</label>
                            <input
                              class="input is-small"
                              type="number"
                              name="hint_cost"
                              value="0"
                              min="0"
                              style="width: 100px"
                            />
                          </div>
                          <div class="control ml-auto">
                            <button
                              type="button"
                              class="button is-small is-danger"
                              onclick="removeHintFromCreate(this)"
                            >
                              <span class="icon">
                                <i class="fas fa-trash"></i>
                              </span>
                            </button>
                          </div>
                        </div>
                        <div class="field">
                          <label class="label">æç¤ºå…§å®¹</label>
                          <div class="control">
                            <textarea
                              class="textarea"
                              name="hint_content"
                              rows="2"
                              placeholder="è¼¸å…¥æç¤ºå…§å®¹..."
                            ></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ“ä½œæŒ‰éˆ• -->
              <div class="field is-grouped is-grouped-right">
                <div class="control">
                  <button
                    type="button"
                    class="button is-light"
                    onclick="window.history.back()"
                  >
                    <span class="icon">
                      <i class="fas fa-arrow-left"></i>
                    </span>
                    <span>å–æ¶ˆ</span>
                  </button>
                </div>
                <div class="control">
                  <button
                    type="submit"
                    class="button is-primary"
                    id="submitBtn"
                  >
                    <span class="icon">
                      <i class="fas fa-plus"></i>
                    </span>
                    <span>å‰µå»ºæŒ‘æˆ°</span>
                  </button>
                </div>
              </div>

              <!-- åŸå§‹ç¢¼æ”¾ç½®ä½ç½®æç¤º -->
              <div class="notification is-info is-light mt-4">
                <div class="content">
                  <h5 class="title is-5">
                    <i class="fas fa-info-circle mr-2"></i>
                    é¡Œç›®åŸå§‹ç¢¼æ”¾ç½®ä½ç½®èªªæ˜
                  </h5>
                  <div class="columns">
                    <div class="column">
                      <h6 class="subtitle is-6">ğŸ“ ç›®éŒ„çµæ§‹</h6>
                      <div class="content">
                        <p>å‰µå»ºæˆåŠŸå¾Œï¼Œè«‹å°‡é¡Œç›®ç›¸é—œæª”æ¡ˆæ”¾ç½®åˆ°ä»¥ä¸‹ç›®éŒ„ï¼š</p>
                        <ul>
                          <li>
                            <strong>src/</strong> - é¡Œç›®åŸå§‹ç¢¼ï¼ˆå®Œæ•´çš„é¡Œç›®å¯¦ç¾ï¼‰
                          </li>
                          <li>
                            <strong>files/</strong> - æä¾›çµ¦åƒè³½è€…ä¸‹è¼‰çš„æª”æ¡ˆ
                          </li>
                          <li><strong>writeup/</strong> - è§£é¡Œèªªæ˜æ–‡æª”</li>
                          <li>
                            <strong>docker/</strong> - Docker éƒ¨ç½²ç›¸é—œæª”æ¡ˆ
                          </li>
                          <li><strong>bin/</strong> - ç·¨è­¯å¾Œçš„å¯åŸ·è¡Œæª”æ¡ˆ</li>
                        </ul>
                      </div>
                    </div>
                    <div class="column">
                      <h6 class="subtitle is-6">ğŸ’¡ é‡è¦æé†’</h6>
                      <div class="content">
                        <ul>
                          <li>
                            ğŸ”’ <strong>src/</strong> ç›®éŒ„ä¸­çš„åŸå§‹ç¢¼<span
                              class="has-text-weight-bold has-text-danger"
                              >ä¸æœƒ</span
                            >æä¾›çµ¦åƒè³½è€…
                          </li>
                          <li>
                            ğŸ“¦ åªæœ‰
                            <strong>files/</strong> ç›®éŒ„ä¸­çš„æª”æ¡ˆæœƒæä¾›ä¸‹è¼‰
                          </li>
                          <li>ğŸ³ Web/PWN é¡é¡Œç›®å»ºè­°ä½¿ç”¨ Docker éƒ¨ç½²</li>
                          <li>
                            ğŸ“ è«‹å‹™å¿…åœ¨
                            <strong>writeup/</strong> ä¸­æ’°å¯«è©³ç´°è§£é¡Œæ­¥é©Ÿ
                          </li>
                          <li>ğŸ” å¯ä»¥åœ¨é¡Œç›®è©³æƒ…é é¢æŸ¥çœ‹å®Œæ•´çš„æª”æ¡ˆçµæ§‹</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // åˆ†æ•¸é…ç½® - å¾å¾Œç«¯å‚³é
  const pointsConfig = {{ config.points | tojson }};

  // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    const difficultySelect = document.getElementById('challengeDifficulty');
    const pointsInput = document.getElementById('challengePoints');

    // ç›£è½é›£åº¦è®Šæ›´äº‹ä»¶
    difficultySelect.addEventListener('change', function() {
      const selectedDifficulty = this.value;
      if (selectedDifficulty && pointsConfig[selectedDifficulty]) {
        pointsInput.value = pointsConfig[selectedDifficulty];
        // æ·»åŠ è¦–è¦ºåé¥‹
        pointsInput.classList.add('is-success');
        setTimeout(() => {
          pointsInput.classList.remove('is-success');
        }, 1500);
      }
    });

    // åˆå§‹åŒ–æ™‚å¦‚æœå·²é¸æ“‡é›£åº¦ï¼Œè‡ªå‹•è¨­ç½®åˆ†æ•¸
    if (difficultySelect.value && pointsConfig[difficultySelect.value]) {
      pointsInput.value = pointsConfig[difficultySelect.value];
    }
  });

  // æç¤ºç®¡ç†åŠŸèƒ½ - å‰µå»ºè¡¨å–®å°ˆç”¨
  function addHintToCreate() {
    const container = document.getElementById("createHintsContainer");
    const hintsCount = container.querySelectorAll(".hint-item").length;
    const newLevel = hintsCount + 1;

    const hintHTML = `
    <div class="box hint-item">
      <div class="field is-grouped">
        <div class="control">
          <label class="label">Level</label>
          <input class="input is-small" type="number" name="hint_level" value="${newLevel}" min="1" style="width: 80px;">
        </div>
        <div class="control">
          <label class="label">èŠ±è²»åˆ†æ•¸</label>
          <input class="input is-small" type="number" name="hint_cost" value="0" min="0" style="width: 100px;">
        </div>
        <div class="control ml-auto">
          <button type="button" class="button is-small is-danger" onclick="removeHintFromCreate(this)">
            <span class="icon">
              <i class="fas fa-trash"></i>
            </span>
          </button>
        </div>
      </div>
      <div class="field">
        <label class="label">æç¤ºå…§å®¹</label>
        <div class="control">
          <textarea class="textarea" name="hint_content" rows="2" placeholder="è¼¸å…¥æç¤ºå…§å®¹..."></textarea>
        </div>
      </div>
    </div>
  `;

    container.insertAdjacentHTML("beforeend", hintHTML);
  }

  function removeHintFromCreate(button) {
    const hintItem = button.closest(".hint-item");
    const container = document.getElementById("createHintsContainer");

    // è‡³å°‘ä¿ç•™ä¸€å€‹æç¤º
    if (container.querySelectorAll(".hint-item").length > 1) {
      hintItem.remove();
    } else {
      alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æç¤º");
    }
  }

  // è¡¨å–®æäº¤
  document
    .getElementById("challengeForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.innerHTML;

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      submitBtn.innerHTML =
        '<span class="icon"><i class="fas fa-spinner fa-pulse"></i></span><span>å‰µå»ºä¸­...</span>';
      submitBtn.disabled = true;

      // æ”¶é›†è¡¨å–®è³‡æ–™
      const formData = new FormData(this);
      const challengeData = {};

      // åŸºæœ¬æ¬„ä½
      for (let [key, value] of formData.entries()) {
        if (key.startsWith("hint_")) continue; // æç¤ºå–®ç¨è™•ç†
        challengeData[key] = value;
      }

      // è™•ç†æç¤º
      const hints = [];
      const hintItems = this.querySelectorAll(".hint-item");
      hintItems.forEach((item) => {
        const level = parseInt(item.querySelector('[name="hint_level"]').value);
        const cost = parseInt(item.querySelector('[name="hint_cost"]').value);
        const content = item
          .querySelector('[name="hint_content"]')
          .value.trim();

        if (level && content) {
          hints.push({ level, cost: cost || 0, content });
        }
      });
      challengeData.hints = hints;

      // ç™¼é€ API è«‹æ±‚
      fetch("/api/challenges", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(challengeData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            alert("æŒ‘æˆ°å‰µå»ºæˆåŠŸï¼");
            window.location.href = "/challenges";
          } else {
            alert("å‰µå»ºå¤±æ•—ï¼š" + data.message);
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("å‰µå»ºæ™‚ç™¼ç”ŸéŒ¯èª¤");
        })
        .finally(() => {
          // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });
</script>
{% endblock %}
