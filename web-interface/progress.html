<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²åº¦æŸ¥çœ‹ - IS1AB CTF ç®¡ç†ä»‹é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-shield-check"></i> IS1AB CTF ç®¡ç†
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="bi bi-house"></i> é¦–é 
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-challenge.html">
                            <i class="bi bi-plus-circle"></i> å‰µå»ºé¡Œç›®
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="progress.html">
                            <i class="bi bi-graph-up"></i> é€²åº¦æŸ¥çœ‹
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-6">
                    <i class="bi bi-graph-up text-primary"></i> é€²åº¦è¿½è¹¤
                </h1>
                <p class="lead text-muted">è©³ç´°çš„é¡Œç›®é–‹ç™¼é€²åº¦å’Œçµ±è¨ˆè³‡è¨Š</p>
            </div>
        </div>

        <!-- éæ¿¾å™¨ -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="filterCategory" class="form-label">åˆ†é¡ç¯©é¸</label>
                                <select class="form-select" id="filterCategory" onchange="applyFilters()">
                                    <option value="">æ‰€æœ‰åˆ†é¡</option>
                                    <option value="web">Web</option>
                                    <option value="pwn">Pwn</option>
                                    <option value="reverse">Reverse</option>
                                    <option value="crypto">Crypto</option>
                                    <option value="forensic">Forensic</option>
                                    <option value="misc">Misc</option>
                                    <option value="general">General</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterStatus" class="form-label">ç‹€æ…‹ç¯©é¸</label>
                                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                    <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                                    <option value="planning">è¦åŠƒä¸­</option>
                                    <option value="developing">é–‹ç™¼ä¸­</option>
                                    <option value="testing">æ¸¬è©¦ä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="deployed">å·²éƒ¨ç½²</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterDifficulty" class="form-label">é›£åº¦ç¯©é¸</label>
                                <select class="form-select" id="filterDifficulty" onchange="applyFilters()">
                                    <option value="">æ‰€æœ‰é›£åº¦</option>
                                    <option value="baby">Baby</option>
                                    <option value="easy">Easy</option>
                                    <option value="middle">Middle</option>
                                    <option value="hard">Hard</option>
                                    <option value="impossible">Impossible</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="searchQuery" class="form-label">æœå°‹</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchQuery" placeholder="æœå°‹é¡Œç›®..." onkeyup="applyFilters()">
                                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> é€²åº¦æ¦‚è¦½</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col">
                                <div class="mb-2">
                                    <div class="fs-3 text-secondary">ğŸ“</div>
                                    <div class="fw-bold fs-5" id="planningCount">-</div>
                                    <small class="text-muted">è¦åŠƒä¸­</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="mb-2">
                                    <div class="fs-3 text-warning">ğŸ”¨</div>
                                    <div class="fw-bold fs-5" id="developingCount">-</div>
                                    <small class="text-muted">é–‹ç™¼ä¸­</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="mb-2">
                                    <div class="fs-3 text-info">ğŸ§ª</div>
                                    <div class="fw-bold fs-5" id="testingCount">-</div>
                                    <small class="text-muted">æ¸¬è©¦ä¸­</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="mb-2">
                                    <div class="fs-3 text-success">âœ…</div>
                                    <div class="fw-bold fs-5" id="completedCount">-</div>
                                    <small class="text-muted">å·²å®Œæˆ</small>
                                </div>
                            </div>
                            <div class="col">
                                <div class="mb-2">
                                    <div class="fs-3 text-primary">ğŸš€</div>
                                    <div class="fw-bold fs-5" id="deployedCount">-</div>
                                    <small class="text-muted">å·²éƒ¨ç½²</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é€²åº¦æ¢ -->
                        <div class="mt-4">
                            <div class="d-flex justify-content-between mb-1">
                                <small>æ•´é«”å®Œæˆåº¦</small>
                                <small id="overallProgress">0%</small>
                            </div>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar bg-success" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> é¡å‹åˆ†å¸ƒ</h5>
                    </div>
                    <div class="card-body">
                        <div id="typeDistribution">
                            <!-- å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è©³ç´°é¡Œç›®åˆ—è¡¨ -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list"></i> é¡Œç›®è©³ç´°åˆ—è¡¨
                            <span class="badge bg-secondary ms-2" id="totalChallengesCount">0</span>
                        </h5>
                        <div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeView('table')">
                                    <i class="bi bi-table"></i> è¡¨æ ¼
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="changeView('card')">
                                    <i class="bi bi-card-list"></i> å¡ç‰‡
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- è¡¨æ ¼æª¢è¦– -->
                        <div id="tableView" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>é¡Œç›®</th>
                                            <th>åˆ†é¡</th>
                                            <th>é›£åº¦</th>
                                            <th>é¡å‹</th>
                                            <th>ç‹€æ…‹</th>
                                            <th>ä½œè€…</th>
                                            <th>åŸå§‹ç¢¼</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="challengeTableBody">
                                        <!-- å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- å¡ç‰‡æª¢è¦– -->
                        <div id="cardView" class="p-3">
                            <div id="challengeCards" class="row">
                                <!-- å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†é¡é€²åº¦çŸ©é™£ -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-grid"></i> åˆ†é¡é€²åº¦çŸ©é™£</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="progressTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 180px;">åˆ†é¡</th>
                                        <th class="text-center">A</th>
                                        <th class="text-center">B</th>
                                        <th class="text-center">C</th>
                                        <th class="text-center">D</th>
                                        <th class="text-center">E</th>
                                        <th class="text-center">F</th>
                                    </tr>
                                </thead>
                                <tbody id="progressTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- åœ–ä¾‹ -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">åœ–ä¾‹èªªæ˜ï¼š</h6>
                            <div class="row small">
                                <div class="col-md-4">
                                    <div class="mb-1"><strong>ç‹€æ…‹åœ–ç¤ºï¼š</strong></div>
                                    <div><span class="badge bg-secondary me-1">ğŸ“</span> è¦åŠƒä¸­</div>
                                    <div><span class="badge bg-warning me-1">ğŸ”¨</span> é–‹ç™¼ä¸­</div>
                                    <div><span class="badge bg-info me-1">ğŸ§ª</span> æ¸¬è©¦ä¸­</div>
                                    <div><span class="badge bg-success me-1">âœ…</span> å·²å®Œæˆ</div>
                                    <div><span class="badge bg-primary me-1">ğŸš€</span> å·²éƒ¨ç½²</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-1"><strong>é›£åº¦é…è‰²ï¼š</strong></div>
                                    <div><span class="badge bg-success me-1">ğŸ¼</span> Baby</div>
                                    <div><span class="badge bg-info me-1">â­</span> Easy</div>
                                    <div><span class="badge bg-warning me-1">â­â­</span> Middle</div>
                                    <div><span class="badge bg-danger me-1">â­â­â­</span> Hard</div>
                                    <div><span class="badge bg-dark me-1">ğŸ’€</span> Impossible</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-1"><strong>å…¶ä»–ï¼š</strong></div>
                                    <div><span class="text-muted me-1">âšª</span> å¾…å‰µå»ºé¡Œç›®</div>
                                    <div><span class="text-muted me-1">â¬œ</span> ä¸éœ€è¦</div>
                                    <div class="mt-2 small text-muted">
                                        æ¯å€‹å¡ç‰‡é¡¯ç¤ºï¼š<br>
                                        â€¢ é¡Œç›®åç¨±<br>
                                        â€¢ ä½œè€… (ğŸ‘¤)<br>
                                        â€¢ é›£åº¦ (ğŸ¯)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api.js"></script>
    <script>
        // å…¨åŸŸè®Šæ•¸
        let challengeData = {};
        let filteredChallenges = [];
        let currentView = 'card';
        let selectedChallenge = null;

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProgressData();
            
            // ç¶å®šæ–°å¢æç¤ºè¡¨å–®äº‹ä»¶
            const addHintForm = document.getElementById('addHintForm');
            if (addHintForm) {
                addHintForm.addEventListener('submit', addNewHint);
            }
        });

        // è¼‰å…¥é€²åº¦è³‡æ–™
        async function loadProgressData() {
            try {
                const progress = await api.getProgress();
                challengeData = progress;
                updateProgressSummary(progress.stats);
                updateTypeDistribution(progress.stats);
                loadProgressTable();
                updateChallengeList(progress.challenges);
            } catch (error) {
                console.error('è¼‰å…¥é€²åº¦å¤±æ•—:', error);
                showConnectionError();
            }
        }


        // æ›´æ–°é€²åº¦æ‘˜è¦
        function updateProgressSummary(stats) {
            document.getElementById('planningCount').textContent = stats.status_counts?.planning || 0;
            document.getElementById('developingCount').textContent = stats.status_counts?.developing || 0;
            document.getElementById('testingCount').textContent = stats.status_counts?.testing || 0;
            document.getElementById('completedCount').textContent = stats.status_counts?.completed || 0;
            document.getElementById('deployedCount').textContent = stats.status_counts?.deployed || 0;

            // è¨ˆç®—æ•´é«”å®Œæˆåº¦
            const completed = (stats.status_counts?.completed || 0) + (stats.status_counts?.deployed || 0);
            const total = stats.total_challenges || 0;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('overallProgress').textContent = `${percentage}%`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        // æ›´æ–°é¡å‹åˆ†å¸ƒ
        function updateTypeDistribution(stats) {
            const types = [
                { name: 'ğŸ“ éœæ…‹é™„ä»¶', count: stats.type_counts?.static_attachment || 0, color: 'primary' },
                { name: 'ğŸ³ éœæ…‹å®¹å™¨', count: stats.type_counts?.static_container || 0, color: 'info' },
                { name: 'ğŸ“‹ å‹•æ…‹é™„ä»¶', count: stats.type_counts?.dynamic_attachment || 0, color: 'warning' },
                { name: 'ğŸ”„ å‹•æ…‹å®¹å™¨', count: stats.type_counts?.dynamic_container || 0, color: 'success' },
                { name: 'ğŸ”Œ NC é¡Œç›®', count: stats.type_counts?.nc_challenge || 0, color: 'danger' }
            ];

            const total = types.reduce((sum, type) => sum + type.count, 0);
            
            let html = '';
            types.forEach(type => {
                const percentage = total > 0 ? Math.round((type.count / total) * 100) : 0;
                if (type.count > 0) {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">${type.name}</span>
                            <span class="badge bg-${type.color}">${type.count}</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-${type.color}" style="width: ${percentage}%"></div>
                        </div>
                    `;
                }
            });

            if (html === '') {
                html = '<p class="text-muted text-center">æš«ç„¡è³‡æ–™</p>';
            }

            document.getElementById('typeDistribution').innerHTML = html;
        }

        // æç¤ºç®¡ç†åŠŸèƒ½ï¼ˆå¾é¦–é è¤‡è£½ï¼‰
        async function openHintsManager(rowIndex, cellIndex, title, category, folderName) {
            try {
                // è¨­ç½®ç•¶å‰é¡Œç›®è³‡è¨Š
                currentHintsChallenge = { category, folderName };
                
                // è¨­ç½®æ¨¡æ…‹æ¡†æ¨™é¡Œ
                const titleElement = document.getElementById('hintsModalTitle');
                if (titleElement) {
                    titleElement.textContent = `${title} (${category})`;
                }
                
                // è¼‰å…¥ç¾æœ‰æç¤º
                await loadChallengeHints(category, folderName);
                
                // é¡¯ç¤ºæ¨¡æ…‹æ¡†
                const modal = new bootstrap.Modal(document.getElementById('hintsModal'));
                modal.show();
            } catch (error) {
                showToast('è¼‰å…¥å¤±æ•—', error.message, 'error');
            }
        }

        // æ–°å¢æç¤ºè¡¨å–®è™•ç†
        async function addNewHint(event) {
            event.preventDefault();
            
            if (!currentHintsChallenge) {
                showToast('éŒ¯èª¤', 'ç„¡æ³•ç²å–é¡Œç›®è³‡è¨Š', 'error');
                return;
            }
            
            const level = parseInt(document.getElementById('hintLevel').value);
            const cost = parseInt(document.getElementById('hintCost').value);
            const content = document.getElementById('hintContent').value;
            
            if (!level || !content) {
                showToast('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´çš„æç¤ºè³‡è¨Š', 'error');
                return;
            }
            
            const hintData = { level, cost: cost || 0, content };
            
            try {
                const response = await fetch(`/api/challenges/${currentHintsChallenge.category}/${currentHintsChallenge.folderName}/hints`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(hintData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'æ–°å¢æç¤ºå¤±æ•—');
                }
                
                showToast('æˆåŠŸ', 'æç¤ºæ–°å¢æˆåŠŸ', 'success');
                
                // é‡æ–°è¼‰å…¥æç¤ºåˆ—è¡¨
                await loadChallengeHints(currentHintsChallenge.category, currentHintsChallenge.folderName);
                
                // é‡ç½®è¡¨å–®
                document.getElementById('addHintForm').reset();
            } catch (error) {
                showToast('æ–°å¢å¤±æ•—', error.message, 'error');
            }
        }

        // é¡¯ç¤ºæç¤ºåˆ—è¡¨
        function renderHints(hints) {
            const container = document.getElementById('existingHints');
            
            if (!container) {
                console.warn('existingHints container not found');
                return;
            }
            
            if (!hints || hints.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center text-muted">
                        <em>å°šæœªè¨­å®šä»»ä½•æç¤º</em>
                    </div>
                `;
                return;
            }
            
            let html = '';
            hints.forEach(hint => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-primary me-2">Level ${hint.level}</span>
                                    <small class="text-muted">${hint.cost} åˆ†</small>
                                </div>
                                <p class="mb-0">${hint.content}</p>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-warning" 
                                    onclick="editHint(${hint.level}, '${hint.content.replace(/'/g, "\\'")}', ${hint.cost})"
                                    title="ç·¨è¼¯">
                                    âœï¸
                                </button>
                                <button type="button" class="btn btn-outline-danger"
                                    onclick="deleteHint(${hint.level})"
                                    title="åˆªé™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // å…¨åŸŸè®Šæ•¸ç”¨æ–¼è¿½è¹¤ç•¶å‰æ­£åœ¨ç®¡ç†æç¤ºçš„é¡Œç›®
        let currentHintsChallenge = null;

        // ç·¨è¼¯æç¤º
        function editHint(level, content, cost) {
            if (!document.getElementById('hintLevel')) {
                console.warn('Hint form elements not found');
                return;
            }
            
            document.getElementById('hintLevel').value = level;
            document.getElementById('hintCost').value = cost;
            document.getElementById('hintContent').value = content;
            
            // æ›´æ”¹æŒ‰éˆ•æ–‡å­—å’Œè¡Œç‚º
            const submitBtn = document.querySelector('#addHintForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'æ›´æ–°æç¤º';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateHint(level);
                };
            }
        }
        
        // æ›´æ–°æç¤º
        async function updateHint(level) {
            if (!currentHintsChallenge) {
                showToast('éŒ¯èª¤', 'ç„¡æ³•ç²å–é¡Œç›®è³‡è¨Š', 'error');
                return;
            }
            
            const hintData = {
                cost: parseInt(document.getElementById('hintCost').value),
                content: document.getElementById('hintContent').value
            };
            
            try {
                const response = await fetch(`/api/challenges/${currentHintsChallenge.category}/${currentHintsChallenge.folderName}/hints/${level}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(hintData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'æ›´æ–°æç¤ºå¤±æ•—');
                }
                
                showToast('æˆåŠŸ', 'æç¤ºæ›´æ–°æˆåŠŸ', 'success');
                
                // é‡æ–°è¼‰å…¥æç¤ºåˆ—è¡¨
                await loadChallengeHints(currentHintsChallenge.category, currentHintsChallenge.folderName);
                
                // é‡ç½®è¡¨å–®å’ŒæŒ‰éˆ•
                document.getElementById('addHintForm').reset();
                const submitBtn = document.querySelector('#addHintForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ–°å¢æç¤º';
                    submitBtn.onclick = null;
                }
            } catch (error) {
                showToast('æ›´æ–°å¤±æ•—', error.message, 'error');
            }
        }
        
        // åˆªé™¤æç¤º
        async function deleteHint(level) {
            if (!currentHintsChallenge) {
                showToast('éŒ¯èª¤', 'ç„¡æ³•ç²å–é¡Œç›®è³‡è¨Š', 'error');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æç¤º ${level} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/challenges/${currentHintsChallenge.category}/${currentHintsChallenge.folderName}/hints/${level}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'åˆªé™¤æç¤ºå¤±æ•—');
                }
                
                showToast('æˆåŠŸ', 'æç¤ºåˆªé™¤æˆåŠŸ', 'success');
                
                // é‡æ–°è¼‰å…¥æç¤ºåˆ—è¡¨
                await loadChallengeHints(currentHintsChallenge.category, currentHintsChallenge.folderName);
            } catch (error) {
                showToast('åˆªé™¤å¤±æ•—', error.message, 'error');
            }
        }
        
        // è¼‰å…¥é¡Œç›®æç¤º
        async function loadChallengeHints(category, folderName) {
            try {
                const response = await fetch(`/api/challenges/${category}/${folderName}/hints`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'è¼‰å…¥æç¤ºå¤±æ•—');
                }
                
                renderHints(data.hints || []);
            } catch (error) {
                console.error('è¼‰å…¥æç¤ºå¤±æ•—:', error);
                renderHints([]);
            }
        }

        async function viewChallenge(category, folderName) {
            // é©—è­‰åƒæ•¸
            if (!category || !folderName || category === 'undefined' || folderName === 'undefined') {
                showToast('éŒ¯èª¤', 'ç„¡æ•ˆçš„é¡Œç›®åƒæ•¸', 'error');
                console.error('Invalid parameters:', { category, folderName });
                return;
            }
            
            try {
                // é¡¯ç¤ºæ¨¡æ…‹æ¡†ä¸¦è¼‰å…¥
                const modal = new bootstrap.Modal(document.getElementById('challengeDetailsModal'));
                document.getElementById('challengeDetailsContent').innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                `;
                modal.show();
                
                // ç²å–é¡Œç›®è©³æƒ…
                const response = await fetch(`/api/challenges/${category}/${folderName}/details`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const challenge = await response.json();
                
                // æ¸²æŸ“é¡Œç›®è©³æƒ…
                renderChallengeDetails(challenge);
                
                // è¨­ç½®æŒ‰éˆ•åŠŸèƒ½
                const hintsBtn = document.getElementById('manageChallengeHintsBtn');
                if (hintsBtn) {
                    hintsBtn.style.display = 'inline-block';
                    hintsBtn.onclick = () => {
                        modal.hide();
                        openHintsManager(0, 0, challenge.title, category, folderName);
                    };
                }
                
                const editBtn = document.getElementById('editChallengeBtn');
                if (editBtn) {
                    editBtn.style.display = 'inline-block';
                    editBtn.onclick = () => {
                        modal.hide();
                        editChallenge(category, folderName);
                    };
                }
                
            } catch (error) {
                console.error('è¼‰å…¥é¡Œç›®è©³æƒ…å¤±æ•—:', error);
                document.getElementById('challengeDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>è¼‰å…¥å¤±æ•—</strong><br>
                        ç„¡æ³•è¼‰å…¥é¡Œç›®è©³æƒ…ï¼š${error.message}
                    </div>
                `;
            }
        }
        
        function renderChallengeDetails(challenge) {
            const difficultyColors = {
                'baby': 'success',
                'easy': 'info', 
                'middle': 'warning',
                'hard': 'danger',
                'impossible': 'dark'
            };
            
            const difficultyIcons = {
                'baby': 'ğŸ¼',
                'easy': 'â­',
                'middle': 'â­â­', 
                'hard': 'â­â­â­',
                'impossible': 'ğŸ’€'
            };
            
            const statusColors = {
                'planning': 'secondary',
                'developing': 'warning',
                'testing': 'info',
                'completed': 'success',
                'deployed': 'primary'
            };
            
            const typeIcons = {
                'nc_challenge': 'ğŸ”Œ',
                'static_container': 'ğŸ³',
                'dynamic_container': 'ğŸ”„',
                'static_attachment': 'ğŸ“',
                'dynamic_attachment': 'ğŸ“‹'
            };
            
            const typeNames = {
                'nc_challenge': 'NC é¡Œç›®',
                'static_container': 'éœæ…‹å®¹å™¨',
                'dynamic_container': 'å‹•æ…‹å®¹å™¨',
                'static_attachment': 'éœæ…‹é™„ä»¶',
                'dynamic_attachment': 'å‹•æ…‹é™„ä»¶'
            };
            
            const difficultyColor = difficultyColors[challenge.difficulty] || 'secondary';
            const difficultyIcon = difficultyIcons[challenge.difficulty] || 'â“';
            const statusColor = statusColors[challenge.status] || 'secondary';
            const statusIcon = getStatusIcon(challenge.status);
            const typeIcon = typeIcons[challenge.challenge_type] || 'ğŸ“';
            const typeName = typeNames[challenge.challenge_type] || challenge.challenge_type;
            
            const hintsHtml = challenge.hints && challenge.hints.length > 0 ? 
                challenge.hints.map(hint => `
                    <div class="alert alert-info alert-sm mb-2">
                        <div class="d-flex justify-content-between">
                            <span><strong>Level ${hint.level}</strong> (${hint.cost} åˆ†)</span>
                        </div>
                        <div class="mt-1">${hint.content}</div>
                    </div>
                `).join('') : '<p class="text-muted">æš«ç„¡æç¤º</p>';
            
            document.getElementById('challengeDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-info-circle"></i> åŸºæœ¬è³‡è¨Š
                        </h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="fw-bold" style="width: 30%;">æ¨™é¡Œ:</td>
                                <td>${challenge.title}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">ä½œè€…:</td>
                                <td>${challenge.author}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">åˆ†é¡:</td>
                                <td><span class="badge bg-secondary">${challenge.category}</span></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">é›£åº¦:</td>
                                <td>
                                    <span class="badge bg-${difficultyColor}">
                                        ${difficultyIcon} ${challenge.difficulty}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">é¡å‹:</td>
                                <td>${typeIcon} ${typeName}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">ç‹€æ…‹:</td>
                                <td>
                                    <span class="badge bg-${statusColor}">
                                        ${statusIcon} ${challenge.status}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold">åˆ†æ•¸:</td>
                                <td>${challenge.points || 'æœªè¨­å®š'}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">åŸå§‹ç¢¼:</td>
                                <td>${challenge.source_code_provided ? 'âœ… æä¾›' : 'âŒ ä¸æä¾›'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-gear"></i> éƒ¨ç½²è³‡è¨Š
                        </h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="fw-bold" style="width: 30%;">å»ºç«‹æ™‚é–“:</td>
                                <td>${challenge.created_at ? new Date(challenge.created_at).toLocaleDateString() : 'æœªçŸ¥'}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">æª”æ¡ˆ:</td>
                                <td>${challenge.files && challenge.files.length > 0 ? challenge.files.join(', ') : 'ç„¡'}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">æ¨™ç±¤:</td>
                                <td>
                                    ${challenge.tags && challenge.tags.length > 0 ? 
                                        challenge.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('') : 
                                        'ç„¡'
                                    }
                                </td>
                            </tr>
                            ${challenge.challenge_type === 'nc_challenge' ? `
                            <tr>
                                <td class="fw-bold">NC ç«¯å£:</td>
                                <td>${challenge.deploy_info?.nc_port || 9999}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">è¶…æ™‚:</td>
                                <td>${challenge.deploy_info?.timeout || 60} ç§’</td>
                            </tr>
                            ` : ''}
                            ${challenge.deploy_info?.url ? `
                            <tr>
                                <td class="fw-bold">URL:</td>
                                <td><a href="${challenge.deploy_info.url}" target="_blank">${challenge.deploy_info.url}</a></td>
                            </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-file-text"></i> é¡Œç›®æè¿°
                        </h6>
                        <div class="bg-light p-3 rounded">
                            ${challenge.description ? challenge.description.replace(/\n/g, '<br>') : 'ç„¡æè¿°'}
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-lightbulb"></i> é¡Œç›®æç¤º
                        </h6>
                        <div>
                            ${hintsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        // è¼‰å…¥é€²åº¦è¡¨æ ¼
        async function loadProgressTable() {
            try {
                const progress = await api.getProgress();
                updateProgressTable(progress);
            } catch (error) {
                updateProgressTable(challengeData);
            }
        }

        // æ›´æ–°é€²åº¦è¡¨æ ¼ï¼ˆèˆ‡é¦–é ç›¸åŒï¼‰
        function updateProgressTable(data) {
            const tbody = document.getElementById('progressTableBody');
            const thead = document.querySelector('#progressTable thead tr');
            
            // å¦‚æœæœ‰æ–°çš„è¡¨æ ¼æ¨™é¡Œï¼Œæ›´æ–°å®ƒå€‘
            if (data.table_headers) {
                let headerHtml = '';
                data.table_headers.forEach(header => {
                    if (header.includes('åˆ†é¡')) {
                        headerHtml += `<th style="width: 180px;">${header}</th>`;
                    } else {
                        headerHtml += `<th class="text-center" style="width: 60px;">${header}</th>`;
                    }
                });
                thead.innerHTML = headerHtml;
            }
            
            let html = '';
            
            // å¦‚æœå¾Œç«¯æä¾›äº†è¡¨æ ¼è¡Œæ•¸æ“šï¼Œç›´æ¥ä½¿ç”¨
            if (data.table_rows) {
                data.table_rows.forEach((row, rowIndex) => {
                    html += '<tr>';
                    row.forEach((cell, cellIndex) => {
                        if (cellIndex === 0) {
                            // åˆ†é¡åç¨±æ¬„ä½
                            html += `<td class="fw-bold">${cell}</td>`;
                        } else {
                            // é¡Œç›®ç‹€æ…‹æ¬„ä½
                            if (typeof cell === 'object' && cell !== null) {
                                if (cell.type === 'challenge') {
                                    // é¡Œç›®å­˜åœ¨çš„æƒ…æ³
                                    html += `
                                        <td class="text-center challenge-cell p-2" style="min-width: 150px;">
                                            <div class="card border-${cell.color} h-100">
                                                <div class="card-body p-2">
                                                    <div class="fw-bold mb-1" style="font-size: 0.9rem; color: var(--ctf-gray-900);">
                                                        ${cell.icon} ${cell.title}
                                                    </div>
                                                    <div class="small mb-1" style="color: var(--ctf-gray-600);">
                                                        ğŸ‘¤ ${cell.author}
                                                    </div>
                                                    <div class="small mb-2">
                                                        <span class="badge bg-${cell.color}" style="font-size: 0.7rem; color: white;">
                                                            ğŸ¯ ${cell.difficulty.charAt(0).toUpperCase() + cell.difficulty.slice(1)}
                                                        </span>
                                                    </div>
                                                    <div class="btn-group btn-group-sm w-100" role="group">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                            onclick="openHintsManager(${rowIndex}, ${cellIndex}, '${cell.title?.replace(/'/g, "\\'")}', '${cell.category}', '${cell.folder_name}')"
                                                            title="ç®¡ç†æç¤º">
                                                            ğŸ’¡
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                            onclick="viewChallenge('${cell.category}', '${cell.folder_name}')"
                                                            title="æŸ¥çœ‹è©³æƒ…">
                                                            ğŸ‘ï¸
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    `;
                                } else if (cell.type === 'empty') {
                                    // å¾…å‰µå»ºé¡Œç›®
                                    html += `
                                        <td class="text-center challenge-cell p-2" style="min-width: 150px;">
                                            <div class="card border-light h-100 border-dashed">
                                                <div class="card-body p-2 d-flex align-items-center justify-content-center">
                                                    <div style="color: var(--ctf-gray-600);">
                                                        <div class="fs-4">âšª</div>
                                                        <div class="small fw-bold">å¾…å‰µå»º</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    `;
                                } else {
                                    // ä¸éœ€è¦çš„æ¬„ä½
                                    html += `
                                        <td class="text-center p-2" style="min-width: 150px;">
                                            <div style="color: var(--ctf-gray-500);">
                                                <div class="fs-4">â¬œ</div>
                                                <div class="small">ä¸éœ€è¦</div>
                                            </div>
                                        </td>
                                    `;
                                }
                            } else {
                                // é™ç´šè™•ç†ï¼šå­—ä¸²å½¢å¼
                                html += `<td class="text-center challenge-cell" title="${cell}">
                                    <div class="fs-5">${cell}</div>
                                </td>`;
                            }
                        }
                    });
                    html += '</tr>';
                });
            } else {
                // é™ç´šè™•ç†ï¼šä½¿ç”¨èˆŠçš„é‚è¼¯
                const categories = data.categories_order || ['general', 'web', 'pwn', 'reverse', 'crypto', 'forensic', 'misc'];
                const quotaConfig = data.quota_config || {};
                const maxChallenges = Math.max(6, ...Object.values(quotaConfig), ...categories.map(cat => (data.challenges?.[cat] || []).length));

                categories.forEach(category => {
                    const challenges = data.challenges?.[category] || [];
                    const quota = quotaConfig[category] || 0;
                    
                    html += `<tr><td class="fw-bold">${category.toUpperCase()}</td>`;
                    
                    for (let i = 0; i < maxChallenges; i++) {
                        if (i < challenges.length) {
                            const challenge = challenges[i];
                            html += `<td class="text-center challenge-cell" onclick="showChallengeDetails('${category}', ${i})" style="cursor: pointer;">
                                <div class="badge bg-success">${challenge.title}</div>
                            </td>`;
                        } else if (i < quota) {
                            html += `<td class="text-center challenge-cell">âšª</td>`;
                        } else {
                            html += `<td class="text-center challenge-cell">â¬œ</td>`;
                        }
                    }
                    
                    html += '</tr>';
                });
            }
            
            tbody.innerHTML = html;
        }

        // èˆŠçš„çŸ©é™£å‡½æ•¸ï¼ˆä¿ç•™ä½œç‚ºå‚™ç”¨ï¼‰
        function updateProgressMatrix(data) {
            // ä½¿ç”¨å¾Œç«¯è¿”å›çš„é…é¡é †åºï¼Œæˆ–ä½¿ç”¨é è¨­é †åº
            const categories = data.categories_order || ['general', 'web', 'pwn', 'reverse', 'crypto', 'forensic', 'misc'];
            const quotaConfig = data.quota_config || {};
            const maxChallenges = Math.max(6, ...Object.values(quotaConfig), ...categories.map(cat => (data.challenges?.[cat] || []).length));

            // è¡¨é ­ - ä½¿ç”¨å‹•æ…‹æ¨™é¡Œ
            let headerHtml = '<th>åˆ†é¡ (ç¾æœ‰/ç›®æ¨™)</th>';
            for (let i = 0; i < maxChallenges; i++) {
                headerHtml += `<th class="text-center" style="width: 150px;">${String.fromCharCode(65 + i)}</th>`;
            }
            document.getElementById('matrixHeader').innerHTML = headerHtml;

            // è¡¨æ ¼å…§å®¹
            let bodyHtml = '';
            categories.forEach(category => {
                const challenges = data.challenges?.[category] || [];
                const targetCount = quotaConfig[category] || challenges.length;
                const categoryDisplay = `${category.charAt(0).toUpperCase() + category.slice(1)} (${challenges.length}/${targetCount})`;
                
                bodyHtml += `<tr><td class="fw-bold">${categoryDisplay}</td>`;
                
                for (let i = 0; i < maxChallenges; i++) {
                    if (i < challenges.length) {
                        const challenge = challenges[i];
                        const title = challenge.title || challenge.name || 'æœªå‘½å';
                        const author = challenge.author || 'æœªçŸ¥';
                        const difficulty = challenge.difficulty || 'easy';
                        const status = challenge.status || 'planning';
                        
                        // é›£åº¦é¡è‰²æ˜ å°„
                        const difficultyColors = {
                            'baby': 'success',
                            'easy': 'info', 
                            'middle': 'warning',
                            'hard': 'danger',
                            'impossible': 'dark'
                        };
                        
                        const statusIcon = getStatusIcon(status);
                        const color = difficultyColors[difficulty] || 'secondary';
                        
                        const folderName = challenge.folder_name || challenge.name || `challenge_${i}`;
                        
                        bodyHtml += `
                            <td class="text-center challenge-cell p-2" style="min-width: 150px;">
                                <div class="card border-${color} h-100">
                                    <div class="card-body p-2">
                                        <div class="fw-bold mb-1" style="font-size: 0.9rem; color: var(--ctf-gray-900);">
                                            ${statusIcon} ${title}
                                        </div>
                                        <div class="small mb-1" style="color: var(--ctf-gray-600);">
                                            ğŸ‘¤ ${author}
                                        </div>
                                        <div class="small mb-2">
                                            <span class="badge bg-${color}" style="font-size: 0.7rem; color: white;">
                                                ğŸ¯ ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}
                                            </span>
                                        </div>
                                        <div class="btn-group btn-group-sm w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="openHintsManager(${categories.indexOf(category)}, ${i}, '${title.replace(/'/g, "\\'")}', '${category}', '${folderName}')"
                                                title="ç®¡ç†æç¤º">
                                                ğŸ’¡
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                onclick="viewChallenge('${category}', '${folderName}')"
                                                title="æŸ¥çœ‹è©³æƒ…">
                                                ğŸ‘ï¸
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;
                    } else if (i < targetCount) {
                        // å¾…å‰µå»ºé¡Œç›®
                        bodyHtml += `
                            <td class="text-center challenge-cell p-2" style="min-width: 150px;">
                                <div class="card border-light h-100 border-dashed">
                                    <div class="card-body p-2 d-flex align-items-center justify-content-center">
                                        <div style="color: var(--ctf-gray-600);">
                                            <div class="fs-4">âšª</div>
                                            <div class="small fw-bold">å¾…å‰µå»º</div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;
                    } else {
                        // ä¸éœ€è¦çš„æ¬„ä½
                        bodyHtml += `
                            <td class="text-center p-2" style="min-width: 150px;">
                                <div style="color: var(--ctf-gray-500);">
                                    <div class="fs-4">â¬œ</div>
                                    <div class="small">ä¸éœ€è¦</div>
                                </div>
                            </td>
                        `;
                    }
                }
                
                bodyHtml += '</tr>';
            });

            document.getElementById('matrixBody').innerHTML = bodyHtml;
        }

        // æ›´æ–°é¡Œç›®åˆ—è¡¨
        function updateChallengeList(challenges) {
            // å¹³å¦åŒ–é¡Œç›®åˆ—è¡¨ä¾¿æ–¼ç¯©é¸
            filteredChallenges = [];
            Object.entries(challenges).forEach(([category, challengeList]) => {
                challengeList.forEach(challenge => {
                    filteredChallenges.push({
                        ...challenge,
                        category: category
                    });
                });
            });

            applyFilters();
        }

        // æ‡‰ç”¨ç¯©é¸å™¨
        function applyFilters() {
            const categoryFilter = document.getElementById('filterCategory').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const difficultyFilter = document.getElementById('filterDifficulty').value;
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();

            let filtered = filteredChallenges.filter(challenge => {
                const matchCategory = !categoryFilter || challenge.category === categoryFilter;
                const matchStatus = !statusFilter || challenge.status === statusFilter;
                const matchDifficulty = !difficultyFilter || challenge.difficulty === difficultyFilter;
                const matchSearch = !searchQuery || 
                    challenge.title.toLowerCase().includes(searchQuery) ||
                    challenge.description.toLowerCase().includes(searchQuery) ||
                    challenge.author.toLowerCase().includes(searchQuery);

                return matchCategory && matchStatus && matchDifficulty && matchSearch;
            });

            // æ›´æ–°è¨ˆæ•¸
            document.getElementById('totalChallengesCount').textContent = filtered.length;

            // æ›´æ–°é¡¯ç¤º
            if (currentView === 'table') {
                updateTableView(filtered);
            } else {
                updateCardView(filtered);
            }
        }

        // æ›´æ–°è¡¨æ ¼æª¢è¦–
        function updateTableView(challenges) {
            let html = '';
            
            challenges.forEach(challenge => {
                const statusColor = getStatusColor(challenge.status);
                const difficultyIcon = getDifficultyIcon(challenge.difficulty);
                const typeIcon = getTypeIcon(challenge.challenge_type);
                const sourceIcon = challenge.source_code_provided ? 'ğŸ“„' : 'ğŸ”’';
                
                html += `
                    <tr onclick="showChallengeDetails('${challenge.category}', '${challenge.folder_name}')" style="cursor: pointer;">
                        <td class="fw-bold">${challenge.title}</td>
                        <td><span class="badge bg-secondary">${challenge.category}</span></td>
                        <td>${difficultyIcon}</td>
                        <td>${typeIcon}</td>
                        <td><span class="badge bg-${statusColor}">${getStatusIcon(challenge.status)} ${challenge.status}</span></td>
                        <td>${challenge.author}</td>
                        <td>${sourceIcon}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editChallenge('${challenge.category}', '${challenge.folder_name}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            if (html === '') {
                html = '<tr><td colspan="8" class="text-center text-muted py-4">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®</td></tr>';
            }

            document.getElementById('challengeTableBody').innerHTML = html;
        }

        // æ›´æ–°å¡ç‰‡æª¢è¦–
        function updateCardView(challenges) {
            let html = '';
            
            challenges.forEach(challenge => {
                const statusColor = getStatusColor(challenge.status);
                const difficultyIcon = getDifficultyIcon(challenge.difficulty);
                const typeIcon = getTypeIcon(challenge.challenge_type);
                const sourceIcon = challenge.source_code_provided ? 'ğŸ“„' : 'ğŸ”’';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 challenge-card" onclick="showChallengeDetails('${challenge.category}', '${challenge.folder_name}')" style="cursor: pointer;">
                            <div class="card-header bg-${statusColor} text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${challenge.title}</h6>
                                <span class="badge bg-light text-dark">${challenge.category}</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text small text-muted">${challenge.description.substring(0, 100)}${challenge.description.length > 100 ? '...' : ''}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        ${difficultyIcon} ${typeIcon} ${sourceIcon}
                                    </small>
                                    <small class="text-muted">${challenge.author}</small>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-${statusColor}">${getStatusIcon(challenge.status)} ${challenge.status}</span>
                                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editChallenge('${challenge.category}', '${challenge.folder_name}')">
                                        <i class="bi bi-pencil"></i> ç·¨è¼¯
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = '<div class="col-12 text-center text-muted py-5">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®</div>';
            }

            document.getElementById('challengeCards').innerHTML = html;
        }

        // åˆ‡æ›æª¢è¦–æ¨¡å¼
        function changeView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åˆ‡æ›æª¢è¦–
            if (view === 'table') {
                document.getElementById('tableView').classList.remove('d-none');
                document.getElementById('cardView').classList.add('d-none');
            } else {
                document.getElementById('tableView').classList.add('d-none');
                document.getElementById('cardView').classList.remove('d-none');
            }
            
            applyFilters();
        }

        // é¡¯ç¤ºé¡Œç›®è©³æƒ…ï¼ˆçµ±ä¸€å‡½æ•¸åç¨±ï¼‰
        async function showChallengeDetails(category, challengeIdentifier) {
            // é©—è­‰åŸºæœ¬åƒæ•¸
            if (!category || category === 'undefined') {
                showToast('éŒ¯èª¤', 'ç„¡æ•ˆçš„é¡Œç›®åˆ†é¡', 'error');
                console.error('Invalid category:', category);
                return;
            }
            
            // è™•ç†ä¸åŒçš„èª¿ç”¨æ–¹å¼
            let folderName = challengeIdentifier;
            
            // å¦‚æœ challengeIdentifier æ˜¯æ•¸å­—ï¼ˆç´¢å¼•ï¼‰ï¼Œå‰‡éœ€è¦æ‰¾åˆ°å°æ‡‰çš„ folderName
            if (typeof challengeIdentifier === 'number') {
                const challenges = challengeData.challenges?.[category];
                if (challenges && challenges[challengeIdentifier]) {
                    folderName = challenges[challengeIdentifier].folder_name;
                } else {
                    showToast('éŒ¯èª¤', 'æ‰¾ä¸åˆ°æŒ‡å®šçš„é¡Œç›®', 'error');
                    return;
                }
            }
            
            // èª¿ç”¨æŸ¥çœ‹è©³æƒ…å‡½æ•¸
            await viewChallenge(category, folderName);
        }

        // ç·¨è¼¯é¡Œç›®
        function editChallenge(category, name) {
            if (category && name) {
                showToast('ç·¨è¼¯é¡Œç›®', `ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­ - ${category}/${name}`, 'info');
            } else if (selectedChallenge) {
                showToast('ç·¨è¼¯é¡Œç›®', `ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­ - ${selectedChallenge.category}/${selectedChallenge.challenge.folder_name}`, 'info');
            }
        }

        // æ¸…é™¤æœå°‹
        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            applyFilters();
        }

        // åˆ·æ–°è³‡æ–™
        function refreshData() {
            loadProgressData();
            showToast('è³‡æ–™å·²åˆ·æ–°', 'é€²åº¦è³‡æ–™å·²é‡æ–°è¼‰å…¥', 'success');
        }

        // è¼”åŠ©å‡½æ•¸
        function getStatusIcon(status) {
            const icons = {
                'planning': 'ğŸ“',
                'developing': 'ğŸ”¨',
                'testing': 'ğŸ§ª',
                'completed': 'âœ…',
                'deployed': 'ğŸš€'
            };
            return icons[status] || 'â“';
        }

        function getStatusColor(status) {
            const colors = {
                'planning': 'secondary',
                'developing': 'warning',
                'testing': 'info',
                'completed': 'success',
                'deployed': 'primary'
            };
            return colors[status] || 'secondary';
        }

        function getTypeIcon(challengeType) {
            const icons = {
                'nc_challenge': 'ğŸ”Œ',
                'static_container': 'ğŸ³',
                'dynamic_container': 'ğŸ”„',
                'static_attachment': 'ğŸ“',
                'dynamic_attachment': 'ğŸ“‹'
            };
            return icons[challengeType] || 'ğŸ“';
        }

        function getTypeName(challengeType) {
            const names = {
                'nc_challenge': 'NC é¡Œç›®',
                'static_container': 'éœæ…‹å®¹å™¨',
                'dynamic_container': 'å‹•æ…‹å®¹å™¨',
                'static_attachment': 'éœæ…‹é™„ä»¶',
                'dynamic_attachment': 'å‹•æ…‹é™„ä»¶'
            };
            return names[challengeType] || challengeType;
        }

        function getDifficultyIcon(difficulty) {
            const icons = {
                'baby': 'ğŸ¼',
                'easy': 'â­',
                'middle': 'â­â­',
                'hard': 'â­â­â­',
                'impossible': 'ğŸ’€'
            };
            return icons[difficulty] || 'â“';
        }

        // é¡¯ç¤º Toast é€šçŸ¥
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong><br>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (document.getElementById(toastId)) {
                    toastContainer.removeChild(toast);
                }
            }, 5000);
        }
    </script>

    <!-- é¡Œç›®è©³æƒ… Modal -->
    <div class="modal fade" id="challengeDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-info-circle text-primary"></i> é¡Œç›®è©³æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="challengeDetailsContent">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="editChallengeBtn" style="display:none;">
                        <i class="bi bi-pencil"></i> ç·¨è¼¯é¡Œç›®
                    </button>
                    <button type="button" class="btn btn-outline-info" id="manageChallengeHintsBtn" style="display:none;">
                        <i class="bi bi-lightbulb"></i> ç®¡ç†æç¤º
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºç®¡ç† Modal -->
    <div class="modal fade" id="hintsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-lightbulb text-warning"></i> é¡Œç›®æç¤ºç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 id="hintsModalTitle">é¡Œç›®åç¨±</h6>
                        <p class="text-muted">ç®¡ç†é¡Œç›®çš„æ¼¸é€²å¼æç¤ºç³»çµ±</p>
                    </div>
                    
                    <!-- ç¾æœ‰æç¤ºåˆ—è¡¨ -->
                    <div class="mb-4">
                        <h6>ğŸ“‹ ç¾æœ‰æç¤º</h6>
                        <div id="existingHints" class="list-group">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æ–°å¢æç¤ºè¡¨å–® -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">â• æ–°å¢æç¤º</h6>
                        </div>
                        <div class="card-body">
                            <form id="addHintForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="hintLevel" class="form-label">æç¤ºç­‰ç´š</label>
                                        <input type="number" class="form-control" id="hintLevel" min="1" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="hintCost" class="form-label">æ¶ˆè€—åˆ†æ•¸</label>
                                        <input type="number" class="form-control" id="hintCost" min="0" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">æ“ä½œ</label>
                                        <div>
                                            <button type="submit" class="btn btn-primary">æ–°å¢æç¤º</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <label for="hintContent" class="form-label">æç¤ºå…§å®¹</label>
                                    <textarea class="form-control" id="hintContent" rows="3" 
                                        placeholder="è¼¸å…¥æ¼¸é€²å¼çš„æç¤ºå…§å®¹..." required></textarea>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>